import { Component, Input } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../tree-cell/components/tree-cell-actions/tree-cell-actions.component";
import * as i2 from "../tree-cell/tree-cell.component";
import * as i3 from "./components/subgrid-head/subgrid-head.component";
import * as i4 from "./components/subgrid-body/subgrid-body.component";
import * as i5 from "@angular/common";
export class SubgridComponent {
    constructor() { }
    ngOnInit() { }
    saveRecord($event) {
        const element = $event.data;
        if (this.configs.actions.resolve_edit) {
            const promise = new Promise((resolve, reject) => {
                this.rowsave.emit({
                    data: element,
                    resolve: resolve
                });
            });
            promise.then(() => {
                this.checkAndRefreshData(element);
            }).catch((err) => { });
        }
        else {
            this.checkAndRefreshData(element);
            this.rowsave.emit(element);
        }
    }
    checkAndRefreshData(element) {
        this.edit_tracker[element[this.configs.id_field]] = false;
        this.internal_configs.show_parent_col = false;
        // Only refresh if Parent has been changed.
        if (this.internal_configs.current_edited_row[this.configs.parent_id_field]
            !== element[this.configs.parent_id_field]) {
            this.refreshData(element);
        }
    }
    refreshData(element) {
        // If edit parent is not true then don't refresh.
        if (!this.configs.actions.edit_parent) {
            return;
        }
        element[this.configs.parent_id_field] = parseInt(element[this.configs.parent_id_field], 10);
        this.expand_tracker = {};
        this.edit_tracker = {};
        this.store.processData(this.store.getRawData(), this.expand_tracker, this.configs, this.edit_tracker, this.internal_configs);
    }
    cancelEdit(row_data) {
        const index = row_data[this.configs.id_field];
        // Cancel all changes ie copy from back up.
        Object.assign(row_data, this.internal_configs.current_edited_row);
        this.edit_tracker[index] = false;
        this.internal_configs.show_parent_col = false;
    }
    onRowExpand(event) {
        const row_data = event.data;
        const promise = new Promise((resolve, reject) => {
            this.expand.emit({
                data: row_data,
                resolve: resolve
            });
        });
        this.expand_tracker[row_data.pathx] = true;
        const blank_row = this.store.showBlankRow(row_data);
        blank_row.loading_children = true;
        // Add Child rows to the table.
        promise.then((child_rows) => {
            blank_row.loading_children = false;
            if (child_rows) {
                child_rows.map(child => {
                    child.leaf = true;
                });
                blank_row.children = child_rows;
            }
            else {
                // Persist old children. If didn't exist then assign blank array.
                if (!blank_row.children) {
                    blank_row.children = [];
                }
            }
        }).catch((err) => { });
    }
    onRowCollapse(event) {
        const row_data = event.data;
        this.expand_tracker[row_data.pathx] = false;
    }
    selectRowOnCheck(row_data, event) {
        if (event.target.checked) {
            row_data.row_selected = true;
            this.rowselect.emit({ data: row_data, event: event });
        }
        else {
            row_data.row_selected = false;
            this.rowdeselect.emit({ data: row_data, event: event });
        }
        this.setSelectAllConfig();
    }
    /**
     * Set Select All config on Select change.
     *
     */
    setSelectAllConfig() {
        let select_all = true;
        this.store.getDisplayData().forEach(data => {
            if (!data.row_selected) {
                select_all = false;
            }
        });
        this.internal_configs.all_selected = select_all;
    }
}
SubgridComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: SubgridComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
SubgridComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.2.1", type: SubgridComponent, selector: "[db-subgrid]", inputs: { store: "store", configs: "configs", expand_tracker: "expand_tracker", edit_tracker: "edit_tracker", internal_configs: "internal_configs", row_data: "row_data", cellclick: "cellclick", expand: "expand", rowselect: "rowselect", rowdeselect: "rowdeselect", rowsave: "rowsave", rowdelete: "rowdelete" }, ngImport: i0, template: "<ng-container *ngIf=\"expand_tracker[row_data.parent_pathx]\">\n\n  <!-- Expandable Row -->\n  <ng-container *ngIf=\"!row_data.leaf\">\n    <td *ngIf=\"configs.multi_select\" class=\"checkbox_column\">\n      <input type=\"checkbox\" [checked]=\"row_data.row_selected\" (click)=\"selectRowOnCheck(row_data, $event)\" \n        [attr.disabled]=\"row_data.selection_disabled\">\n    </td>\n    <td db-tree-cell-actions \n      *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"\n      [row_data]=\"row_data\"\n      [configs]=\"configs\"\n      [store]=\"store\"\n      [edit_tracker]=\"edit_tracker\"\n      [internal_configs]=\"internal_configs\"\n      [rowdelete]=\"rowdelete\"\n      (canceledit)=\"cancelEdit($event)\" \n      (editcomplete)=\"saveRecord($event)\"\n      >\n    </td>\n    <td *ngFor=\"let column of configs.columns; index as i\" \n      [ngClass]=\"{'column-hide': column.hidden, 'expand-column': i == 0}\">\n      <db-tree-cell\n        [configs]=\"configs\"\n        [column]=\"column\"\n        [index]=\"i\"\n        [row_data]=\"row_data\"\n        [expand_tracker]=\"expand_tracker\"\n        [edit_on]=\"edit_tracker[row_data[configs.id_field]]\"\n        [cellclick]=\"cellclick\"\n        (rowexpand)=\"onRowExpand($event)\"\n        (rowcollapse)=\"onRowCollapse($event)\"\n        (editcomplete)=\"saveRecord($event)\"\n      >\n      </db-tree-cell>\n    </td>\n  </ng-container>\n\n  <!-- Subgrid Rows -->\n  <ng-container *ngIf=\"row_data.leaf\">    \n    <td *ngIf=\"configs.multi_select\"></td>\n    <td *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"></td>\n    <td [attr.colspan]=\"configs.columns.length\" class=\"subgrid-column\">\n        <table class=\"subgrid-table\">\n          <thead db-subgrid-head\n            [row_data]=\"row_data\"\n            [configs]=\"configs\">\n            \n          </thead>\n          <tbody db-subgrid-body\n            [configs]=\"configs\"\n            [expand_tracker]=\"expand_tracker\"\n            [cellclick]=\"cellclick\"\n            [row_data]=\"row_data\">\n          </tbody>            \n        </table>\n    </td>    \n  </ng-container>  \n</ng-container>", styles: ["tr{border-bottom:1px solid #cdd5dc}tr.selected{background-color:#e2e7eb}tr span.parent_container{padding-left:45px}tr.child{background:#fff}tr.child td:nth-child(2){padding:.875rem 1.25rem .875rem 2.5rem!important}tr.parent{background:#fafbff}tr.subgrid-row{background:#fcfcfc}tr td{vertical-align:middle;position:relative;padding:.5rem;box-sizing:border-box}tr td.checkbox_column{text-align:center}tr td.expand-column{padding:.3rem}tr td.column-hide{display:none}tr td.clear-left-border{border-left:0!important}tr td.clear-right-border{border-right:0!important}tr td select{padding:5px;border:1px solid #d1cece}.db-tree-view{line-height:1.5em;border-collapse:collapse;border-spacing:0;display:table;max-width:100%;overflow:auto;word-break:normal;word-break:keep-all;color:#4b4b4b}tr{border-bottom:1px solid #cdd5dc;background:#fff}tr th{font-size:1rem;font-weight:600;line-height:1.25;color:#181818;vertical-align:middle;position:relative;box-sizing:border-box}tr th div{padding:.5rem}tr th.column-hide{display:none}tr th.action-column span.icon-container{cursor:pointer}tr th span.inbuild-icon{font-size:25px}th.clear-left-border{border-left:0!important}th.clear-right-border{border-right:0!important}.column-hide{display:none}svg{width:25px;padding-right:3px}td{border:1px solid #cdd5dc;vertical-align:middle;position:relative;padding:.5rem;box-sizing:border-box}td.checkbox_column{text-align:center}td.expand-column{padding:.3rem}td.subgrid-column{padding:0}td.column-hide{display:none}td.clear-left-border{border-left:0!important}td.clear-right-border{border-right:0!important}td table.subgrid-table{border-collapse:collapse;width:100%}\n"], components: [{ type: i1.TreeCellActionsComponent, selector: "[db-tree-cell-actions]", inputs: ["store", "edit_tracker", "internal_configs", "configs", "rowdelete", "row_data"], outputs: ["editcomplete", "canceledit"] }, { type: i2.TreeCellComponent, selector: "db-tree-cell", inputs: ["configs", "index", "row_data", "column", "expand_tracker", "cellclick", "edit_on"], outputs: ["rowexpand", "rowcollapse", "canceledit", "editcomplete"] }, { type: i3.SubgridHeadComponent, selector: "[db-subgrid-head]", inputs: ["configs", "row_data"] }, { type: i4.SubgridBodyComponent, selector: "[db-subgrid-body]", inputs: ["configs", "expand_tracker", "row_data", "cellclick"] }], directives: [{ type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i5.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i5.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: SubgridComponent, decorators: [{
            type: Component,
            args: [{ selector: '[db-subgrid]', template: "<ng-container *ngIf=\"expand_tracker[row_data.parent_pathx]\">\n\n  <!-- Expandable Row -->\n  <ng-container *ngIf=\"!row_data.leaf\">\n    <td *ngIf=\"configs.multi_select\" class=\"checkbox_column\">\n      <input type=\"checkbox\" [checked]=\"row_data.row_selected\" (click)=\"selectRowOnCheck(row_data, $event)\" \n        [attr.disabled]=\"row_data.selection_disabled\">\n    </td>\n    <td db-tree-cell-actions \n      *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"\n      [row_data]=\"row_data\"\n      [configs]=\"configs\"\n      [store]=\"store\"\n      [edit_tracker]=\"edit_tracker\"\n      [internal_configs]=\"internal_configs\"\n      [rowdelete]=\"rowdelete\"\n      (canceledit)=\"cancelEdit($event)\" \n      (editcomplete)=\"saveRecord($event)\"\n      >\n    </td>\n    <td *ngFor=\"let column of configs.columns; index as i\" \n      [ngClass]=\"{'column-hide': column.hidden, 'expand-column': i == 0}\">\n      <db-tree-cell\n        [configs]=\"configs\"\n        [column]=\"column\"\n        [index]=\"i\"\n        [row_data]=\"row_data\"\n        [expand_tracker]=\"expand_tracker\"\n        [edit_on]=\"edit_tracker[row_data[configs.id_field]]\"\n        [cellclick]=\"cellclick\"\n        (rowexpand)=\"onRowExpand($event)\"\n        (rowcollapse)=\"onRowCollapse($event)\"\n        (editcomplete)=\"saveRecord($event)\"\n      >\n      </db-tree-cell>\n    </td>\n  </ng-container>\n\n  <!-- Subgrid Rows -->\n  <ng-container *ngIf=\"row_data.leaf\">    \n    <td *ngIf=\"configs.multi_select\"></td>\n    <td *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"></td>\n    <td [attr.colspan]=\"configs.columns.length\" class=\"subgrid-column\">\n        <table class=\"subgrid-table\">\n          <thead db-subgrid-head\n            [row_data]=\"row_data\"\n            [configs]=\"configs\">\n            \n          </thead>\n          <tbody db-subgrid-body\n            [configs]=\"configs\"\n            [expand_tracker]=\"expand_tracker\"\n            [cellclick]=\"cellclick\"\n            [row_data]=\"row_data\">\n          </tbody>            \n        </table>\n    </td>    \n  </ng-container>  \n</ng-container>", styles: ["tr{border-bottom:1px solid #cdd5dc}tr.selected{background-color:#e2e7eb}tr span.parent_container{padding-left:45px}tr.child{background:#fff}tr.child td:nth-child(2){padding:.875rem 1.25rem .875rem 2.5rem!important}tr.parent{background:#fafbff}tr.subgrid-row{background:#fcfcfc}tr td{vertical-align:middle;position:relative;padding:.5rem;box-sizing:border-box}tr td.checkbox_column{text-align:center}tr td.expand-column{padding:.3rem}tr td.column-hide{display:none}tr td.clear-left-border{border-left:0!important}tr td.clear-right-border{border-right:0!important}tr td select{padding:5px;border:1px solid #d1cece}.db-tree-view{line-height:1.5em;border-collapse:collapse;border-spacing:0;display:table;max-width:100%;overflow:auto;word-break:normal;word-break:keep-all;color:#4b4b4b}tr{border-bottom:1px solid #cdd5dc;background:#fff}tr th{font-size:1rem;font-weight:600;line-height:1.25;color:#181818;vertical-align:middle;position:relative;box-sizing:border-box}tr th div{padding:.5rem}tr th.column-hide{display:none}tr th.action-column span.icon-container{cursor:pointer}tr th span.inbuild-icon{font-size:25px}th.clear-left-border{border-left:0!important}th.clear-right-border{border-right:0!important}.column-hide{display:none}svg{width:25px;padding-right:3px}td{border:1px solid #cdd5dc;vertical-align:middle;position:relative;padding:.5rem;box-sizing:border-box}td.checkbox_column{text-align:center}td.expand-column{padding:.3rem}td.subgrid-column{padding:0}td.column-hide{display:none}td.clear-left-border{border-left:0!important}td.clear-right-border{border-right:0!important}td table.subgrid-table{border-collapse:collapse;width:100%}\n"] }]
        }], ctorParameters: function () { return []; }, propDecorators: { store: [{
                type: Input
            }], configs: [{
                type: Input
            }], expand_tracker: [{
                type: Input
            }], edit_tracker: [{
                type: Input
            }], internal_configs: [{
                type: Input
            }], row_data: [{
                type: Input
            }], cellclick: [{
                type: Input
            }], expand: [{
                type: Input
            }], rowselect: [{
                type: Input
            }], rowdeselect: [{
                type: Input
            }], rowsave: [{
                type: Input
            }], rowdelete: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViZ3JpZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLXRyZWUtZ3JpZC9zcmMvbGliL21vZHVsZXMvc3ViZ3JpZC9zdWJncmlkLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItdHJlZS1ncmlkL3NyYy9saWIvbW9kdWxlcy9zdWJncmlkL3N1YmdyaWQuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxLQUFLLEVBQWdCLE1BQU0sZUFBZSxDQUFDOzs7Ozs7O0FBU3ZFLE1BQU0sT0FBTyxnQkFBZ0I7SUFzQzNCLGdCQUFnQixDQUFDO0lBRWpCLFFBQVEsS0FBSSxDQUFDO0lBRWIsVUFBVSxDQUFDLE1BQU07UUFDZixNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBRTVCLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO1lBQ3JDLE1BQU0sT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO2dCQUM5QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztvQkFDaEIsSUFBSSxFQUFFLE9BQU87b0JBQ2IsT0FBTyxFQUFFLE9BQU87aUJBQ2pCLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRUgsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ2hCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNwQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ3ZCO2FBQU07WUFDTCxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFD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Q3RCLFVBQVUsR0FBRyxLQUFLLENBQUM7YUFDcEI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEdBQUcsVUFBVSxDQUFDO0lBRWxELENBQUM7OzZHQXRLVSxnQkFBZ0I7aUdBQWhCLGdCQUFnQiwwV0NUN0IsMnFFQTBEZTsyRkRqREYsZ0JBQWdCO2tCQUw1QixTQUFTOytCQUNFLGNBQWM7MEVBT3hCLEtBQUs7c0JBREosS0FBSztnQkFJTixPQUFPO3NCQUROLEtBQUs7Z0JBSU4sY0FBYztzQkFEYixLQUFLO2dCQUlOLFlBQVk7c0JBRFgsS0FBSztnQkFJTixnQkFBZ0I7c0JBRGYsS0FBSztnQkFJTixRQUFRO3NCQURQLEtBQUs7Z0JBSU4sU0FBUztzQkFEUixLQUFLO2dCQUlOLE1BQU07c0JBREwsS0FBSztnQkFJTixTQUFTO3NCQURSLEtBQUs7Z0JBSU4sV0FBVztzQkFEVixLQUFLO2dCQUlOLE9BQU87c0JBRE4sS0FBSztnQkFJTixTQUFTO3NCQURSLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgSW5wdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICcuLi8uLi9zdG9yZS9zdG9yZSc7XG5pbXBvcnQgeyBDb25maWdzIH0gZnJvbSAnLi4vLi4vbW9kZWxzL0NvbmZpZ3MubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdbZGItc3ViZ3JpZF0nLFxuICB0ZW1wbGF0ZVVybDogJy4vc3ViZ3JpZC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3N1YmdyaWQuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBTdWJncmlkQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICBASW5wdXQoKVxuICBzdG9yZTogU3RvcmU7XG5cbiAgQElucHV0KClcbiAgY29uZmlnczogQ29uZmlncztcblxuICBASW5wdXQoKVxuICBleHBhbmRfdHJhY2tlcjogYW55O1xuXG4gIEBJbnB1dCgpXG4gIGVkaXRfdHJhY2tlcjogYW55O1xuXG4gIEBJbnB1dCgpXG4gIGludGVybmFsX2NvbmZpZ3M6IGFueTtcblxuICBASW5wdXQoKVxuICByb3dfZGF0YTogYW55O1xuXG4gIEBJbnB1dCgpXG4gIGNlbGxjbGljazogRXZlbnRFbWl0dGVyPGFueT47XG5cbiAgQElucHV0KClcbiAgZXhwYW5kOiBFdmVudEVtaXR0ZXI8YW55PjtcblxuICBASW5wdXQoKVxuICByb3dzZWxlY3Q6IEV2ZW50RW1pdHRlcjxhbnk+O1xuXG4gIEBJbnB1dCgpXG4gIHJvd2Rlc2VsZWN0OiBFdmVudEVtaXR0ZXI8YW55PjtcblxuICBASW5wdXQoKVxuICByb3dzYXZlOiBFdmVudEVtaXR0ZXI8YW55PjtcblxuICBASW5wdXQoKVxuICByb3dkZWxldGU6IEV2ZW50RW1pdHRlcjxhbnk+O1xuXG4gIGNvbnN0cnVjdG9yKCkgeyB9XG5cbiAgbmdPbkluaXQoKSB7fVxuXG4gIHNhdmVSZWNvcmQoJGV2ZW50KSB7XG4gICAgY29uc3QgZWxlbWVudCA9ICRldmVudC5kYXRhO1xuXG4gICAgaWYgKHRoaXMuY29uZmlncy5hY3Rpb25zLnJlc29sdmVfZWRpdCkge1xuICAgICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy5yb3dzYXZlLmVtaXQoe1xuICAgICAgICAgIGRhdGE6IGVsZW1lbnQsXG4gICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBwcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLmNoZWNrQW5kUmVmcmVzaERhdGEoZWxlbWVudCk7XG4gICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7fSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2hlY2tBbmRSZWZyZXNoRGF0YShlbGVtZW50KTtcbiAgICAgIHRoaXMucm93c2F2ZS5lbWl0KGVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIGNoZWNrQW5kUmVmcmVzaERhdGEoZWxlbWVudCkge1xuICAgIHRoaXMuZWRpdF90cmFja2VyW2VsZW1lbnRbdGhpcy5jb25maWdzLmlkX2ZpZWxkXV0gPSBmYWxzZTtcbiAgICB0aGlzLmludGVybmFsX2NvbmZpZ3Muc2hvd19wYXJlbnRfY29sID0gZmFsc2U7XG5cbiAgICAvLyBPbmx5IHJlZnJlc2ggaWYgUGFyZW50IGhhcyBiZWVuIGNoYW5nZWQuXG4gICAgaWYgKHRoaXMuaW50ZXJuYWxfY29uZmlncy5jdXJyZW50X2VkaXRlZF9yb3dbdGhpcy5jb25maWdzLnBhcmVudF9pZF9maWVsZF1cbiAgICAgICE9PSBlbGVtZW50W3RoaXMuY29uZmlncy5wYXJlbnRfaWRfZmllbGRdKSB7XG4gICAgICAgIHRoaXMucmVmcmVzaERhdGEoZWxlbWVudCk7XG4gICAgfVxuICB9XG5cbiAgcmVmcmVzaERhdGEoZWxlbWVudCkge1xuICAgIC8vIElmIGVkaXQgcGFyZW50IGlzIG5vdCB0cnVlIHRoZW4gZG9uJ3QgcmVmcmVzaC5cbiAgICBpZiAoIXRoaXMuY29uZmlncy5hY3Rpb25zLmVkaXRfcGFyZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGVsZW1lbnRbdGhpcy5jb25maWdzLnBhcmVudF9pZF9maWVsZF0gPSBwYXJzZUludChlbGVtZW50W3RoaXMuY29uZmlncy5wYXJlbnRfaWRfZmllbGRdLCAxMCk7XG4gICAgdGhpcy5leHBhbmRfdHJhY2tlciA9IHt9O1xuICAgIHRoaXMuZWRpdF90cmFja2VyID0ge307XG4gICAgdGhpcy5zdG9yZS5wcm9jZXNzRGF0YShcbiAgICAgIHRoaXMuc3RvcmUuZ2V0UmF3RGF0YSgpLFxuICAgICAgdGhpcy5leHBhbmRfdHJhY2tlcixcbiAgICAgIHRoaXMuY29uZmlncyxcbiAgICAgIHRoaXMuZWRpdF90cmFja2VyLFxuICAgICAgdGhpcy5pbnRlcm5hbF9jb25maWdzXG4gICAgKTtcbiAgfVxuXG4gIGNhbmNlbEVkaXQocm93X2RhdGEpIHtcbiAgICBjb25zdCBpbmRleCA9IHJvd19kYXRhW3RoaXMuY29uZmlncy5pZF9maWVsZF07XG5cbiAgICAvLyBDYW5jZWwgYWxsIGNoYW5nZXMgaWUgY29weSBmcm9tIGJhY2sgdXAuXG4gICAgT2JqZWN0LmFzc2lnbihyb3dfZGF0YSwgdGhpcy5pbnRlcm5hbF9jb25maWdzLmN1cnJlbnRfZWRpdGVkX3Jvdyk7XG5cbiAgICB0aGlzLmVkaXRfdHJhY2tlcltpbmRleF0gPSBmYWxzZTtcbiAgICB0aGlzLmludGVybmFsX2NvbmZpZ3Muc2hvd19wYXJlbnRfY29sID0gZmFsc2U7XG4gIH1cblxuICBvblJvd0V4cGFuZChldmVudCkge1xuICAgIGNvbnN0IHJvd19kYXRhID0gZXZlbnQuZGF0YTtcblxuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmV4cGFuZC5lbWl0KHtcbiAgICAgICAgZGF0YTogcm93X2RhdGEsXG4gICAgICAgIHJlc29sdmU6IHJlc29sdmVcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgdGhpcy5leHBhbmRfdHJhY2tlcltyb3dfZGF0YS5wYXRoeF0gPSB0cnVlO1xuICAgIGNvbnN0IGJsYW5rX3JvdzogYW55ID0gdGhpcy5zdG9yZS5zaG93QmxhbmtSb3cocm93X2RhdGEpO1xuICAgIGJsYW5rX3Jvdy5sb2FkaW5nX2NoaWxkcmVuID0gdHJ1ZTtcblxuICAgIC8vIEFkZCBDaGlsZCByb3dzIHRvIHRoZSB0YWJsZS5cbiAgICBwcm9taXNlLnRoZW4oKGNoaWxkX3Jvd3M6IGFueSkgPT4ge1xuICAgICAgYmxhbmtfcm93LmxvYWRpbmdfY2hpbGRyZW4gPSBmYWxzZTtcblxuICAgICAgaWYgKGNoaWxkX3Jvd3MpIHtcbiAgICAgICAgY2hpbGRfcm93cy5tYXAoY2hpbGQgPT4ge1xuICAgICAgICAgIGNoaWxkLmxlYWYgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgYmxhbmtfcm93LmNoaWxkcmVuID0gY2hpbGRfcm93cztcbiAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgLy8gUGVyc2lzdCBvbGQgY2hpbGRyZW4uIElmIGRpZG4ndCBleGlzdCB0aGVuIGFzc2lnbiBibGFuayBhcnJheS5cbiAgICAgICAgaWYgKCFibGFua19yb3cuY2hpbGRyZW4pIHtcbiAgICAgICAgICBibGFua19yb3cuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge30pO1xuICB9XG5cbiAgb25Sb3dDb2xsYXBzZShldmVudCkge1xuICAgIGNvbnN0IHJvd19kYXRhID0gZXZlbnQuZGF0YTtcbiAgICB0aGlzLmV4cGFuZF90cmFja2VyW3Jvd19kYXRhLnBhdGh4XSA9IGZhbHNlO1xuICB9XG5cbiAgc2VsZWN0Um93T25DaGVjayhyb3dfZGF0YSwgZXZlbnQpIHtcbiAgICBpZiAoZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHtcbiAgICAgIHJvd19kYXRhLnJvd19zZWxlY3RlZCA9IHRydWU7XG4gICAgICB0aGlzLnJvd3NlbGVjdC5lbWl0KHtkYXRhOiByb3dfZGF0YSwgZXZlbnQ6IGV2ZW50fSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJvd19kYXRhLnJvd19zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5yb3dkZXNlbGVjdC5lbWl0KHtkYXRhOiByb3dfZGF0YSwgZXZlbnQ6IGV2ZW50fSk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRTZWxlY3RBbGxDb25maWcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgU2VsZWN0IEFsbCBjb25maWcgb24gU2VsZWN0IGNoYW5nZS5cbiAgICpcbiAgICovXG4gIHNldFNlbGVjdEFsbENvbmZpZygpIHtcbiAgICBsZXQgc2VsZWN0X2FsbCA9IHRydWU7XG5cbiAgICB0aGlzLnN0b3JlLmdldERpc3BsYXlEYXRhKCkuZm9yRWFjaChkYXRhID0+IHtcbiAgICAgIGlmICghZGF0YS5yb3dfc2VsZWN0ZWQpIHtcbiAgICAgICAgc2VsZWN0X2FsbCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLmFsbF9zZWxlY3RlZCA9IHNlbGVjdF9hbGw7XG5cbiAgfVxuXG59XG4iLCI8bmctY29udGFpbmVyICpuZ0lmPVwiZXhwYW5kX3RyYWNrZXJbcm93X2RhdGEucGFyZW50X3BhdGh4XVwiPlxuXG4gIDwhLS0gRXhwYW5kYWJsZSBSb3cgLS0+XG4gIDxuZy1jb250YWluZXIgKm5nSWY9XCIhcm93X2RhdGEubGVhZlwiPlxuICAgIDx0ZCAqbmdJZj1cImNvbmZpZ3MubXVsdGlfc2VsZWN0XCIgY2xhc3M9XCJjaGVja2JveF9jb2x1bW5cIj5cbiAgICAgIDxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBbY2hlY2tlZF09XCJyb3dfZGF0YS5yb3dfc2VsZWN0ZWRcIiAoY2xpY2spPVwic2VsZWN0Um93T25DaGVjayhyb3dfZGF0YSwgJGV2ZW50KVwiIFxuICAgICAgICBbYXR0ci5kaXNhYmxlZF09XCJyb3dfZGF0YS5zZWxlY3Rpb25fZGlzYWJsZWRcIj5cbiAgICA8L3RkPlxuICAgIDx0ZCBkYi10cmVlLWNlbGwtYWN0aW9ucyBcbiAgICAgICpuZ0lmPVwiKGNvbmZpZ3MuYWN0aW9ucy5lZGl0IHx8IGNvbmZpZ3MuYWN0aW9ucy5kZWxldGUgfHwgY29uZmlncy5hY3Rpb25zLmFkZClcIlxuICAgICAgW3Jvd19kYXRhXT1cInJvd19kYXRhXCJcbiAgICAgIFtjb25maWdzXT1cImNvbmZpZ3NcIlxuICAgICAgW3N0b3JlXT1cInN0b3JlXCJcbiAgICAgIFtlZGl0X3RyYWNrZXJdPVwiZWRpdF90cmFja2VyXCJcbiAgICAgIFtpbnRlcm5hbF9jb25maWdzXT1cImludGVybmFsX2NvbmZpZ3NcIlxuICAgICAgW3Jvd2RlbGV0ZV09XCJyb3dkZWxldGVcIlxuICAgICAgKGNhbmNlbGVkaXQpPVwiY2FuY2VsRWRpdCgkZXZlbnQpXCIgXG4gICAgICAoZWRpdGNvbXBsZXRlKT1cInNhdmVSZWNvcmQoJGV2ZW50KVwiXG4gICAgICA+XG4gICAgPC90ZD5cbiAgICA8dGQgKm5nRm9yPVwibGV0IGNvbHVtbiBvZiBjb25maWdzLmNvbHVtbnM7IGluZGV4IGFzIGlcIiBcbiAgICAgIFtuZ0NsYXNzXT1cInsnY29sdW1uLWhpZGUnOiBjb2x1bW4uaGlkZGVuLCAnZXhwYW5kLWNvbHVtbic6IGkgPT0gMH1cIj5cbiAgICAgIDxkYi10cmVlLWNlbGxcbiAgICAgICAgW2NvbmZpZ3NdPVwiY29uZmlnc1wiXG4gICAgICAgIFtjb2x1bW5dPVwiY29sdW1uXCJcbiAgICAgICAgW2luZGV4XT1cImlcIlxuICAgICAgICBbcm93X2RhdGFdPVwicm93X2RhdGFcIlxuICAgICAgICBbZXhwYW5kX3RyYWNrZXJdPVwiZXhwYW5kX3RyYWNrZXJcIlxuICAgICAgICBbZWRpdF9vbl09XCJlZGl0X3RyYWNrZXJbcm93X2RhdGFbY29uZmlncy5pZF9maWVsZF1dXCJcbiAgICAgICAgW2NlbGxjbGlja109XCJjZWxsY2xpY2tcIlxuICAgICAgICAocm93ZXhwYW5kKT1cIm9uUm93RXhwYW5kKCRldmVudClcIlxuICAgICAgICAocm93Y29sbGFwc2UpPVwib25Sb3dDb2xsYXBzZSgkZXZlbnQpXCJcbiAgICAgICAgKGVkaXRjb21wbGV0ZSk9XCJzYXZlUmVjb3JkKCRldmVudClcIlxuICAgICAgPlxuICAgICAgPC9kYi10cmVlLWNlbGw+XG4gICAgPC90ZD5cbiAgPC9uZy1jb250YWluZXI+XG5cbiAgPCEtLSBTdWJncmlkIFJvd3MgLS0+XG4gIDxuZy1jb250YWluZXIgKm5nSWY9XCJyb3dfZGF0YS5sZWFmXCI+ICAgIFxuICAgIDx0ZCAqbmdJZj1cImNvbmZpZ3MubXVsdGlfc2VsZWN0XCI+PC90ZD5cbiAgICA8dGQgKm5nSWY9XCIoY29uZmlncy5hY3Rpb25zLmVkaXQgfHwgY29uZmlncy5hY3Rpb25zLmRlbGV0ZSB8fCBjb25maWdzLmFjdGlvbnMuYWRkKVwiPjwvdGQ+XG4gICAgPHRkIFthdHRyLmNvbHNwYW5dPVwiY29uZmlncy5jb2x1bW5zLmxlbmd0aFwiIGNsYXNzPVwic3ViZ3JpZC1jb2x1bW5cIj5cbiAgICAgICAgPHRhYmxlIGNsYXNzPVwic3ViZ3JpZC10YWJsZVwiPlxuICAgICAgICAgIDx0aGVhZCBkYi1zdWJncmlkLWhlYWRcbiAgICAgICAgICAgIFtyb3dfZGF0YV09XCJyb3dfZGF0YVwiXG4gICAgICAgICAgICBbY29uZmlnc109XCJjb25maWdzXCI+XG4gICAgICAgICAgICBcbiAgICAgICAgICA8L3RoZWFkPlxuICAgICAgICAgIDx0Ym9keSBkYi1zdWJncmlkLWJvZHlcbiAgICAgICAgICAgIFtjb25maWdzXT1cImNvbmZpZ3NcIlxuICAgICAgICAgICAgW2V4cGFuZF90cmFja2VyXT1cImV4cGFuZF90cmFja2VyXCJcbiAgICAgICAgICAgIFtjZWxsY2xpY2tdPVwiY2VsbGNsaWNrXCJcbiAgICAgICAgICAgIFtyb3dfZGF0YV09XCJyb3dfZGF0YVwiPlxuICAgICAgICAgIDwvdGJvZHk+ICAgICAgICAgICAgXG4gICAgICAgIDwvdGFibGU+XG4gICAgPC90ZD4gICAgXG4gIDwvbmctY29udGFpbmVyPiAgXG48L25nLWNvbnRhaW5lcj4iXX0=