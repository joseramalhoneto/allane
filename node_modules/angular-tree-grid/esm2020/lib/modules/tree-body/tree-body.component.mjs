import { Component, Input } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "../../angular-tree-grid.service";
import * as i2 from "./components/filter-row/filter-row.component";
import * as i3 from "./components/add-row/add-row.component";
import * as i4 from "../subgrid/subgrid.component";
import * as i5 from "../tree-cell/components/tree-cell-actions/tree-cell-actions.component";
import * as i6 from "../tree-cell/tree-cell.component";
import * as i7 from "@angular/common";
import * as i8 from "@angular/forms";
export class TreeBodyComponent {
    constructor(angularTreeGridService) {
        this.angularTreeGridService = angularTreeGridService;
        this.parents = [];
    }
    ngOnInit() {
        this.display_data = this.store.getDisplayData();
        this.angularTreeGridService.display_data_observable$.subscribe((store) => {
            this.display_data = this.store.getDisplayData();
            this.setParents();
        });
        this.setParents();
    }
    setParents() {
        this.parents = this.store.raw_data.map(element => {
            return {
                'id': element[this.configs.id_field],
                'value': element[this.configs.parent_display_field]
            };
        });
    }
    refreshData(element) {
        // If edit parent is not true then don't refresh.
        if (!this.configs.actions.edit_parent) {
            return;
        }
        element[this.configs.parent_id_field] = parseInt(element[this.configs.parent_id_field], 10);
        this.expand_tracker = {};
        this.edit_tracker = {};
        this.store.processData(this.store.getRawData(), this.expand_tracker, this.configs, this.edit_tracker, this.internal_configs);
    }
    onRowExpand(event) {
        const row_data = event.data;
        if (!this.configs.load_children_on_expand) {
            this.expand_tracker[row_data.pathx] = true;
            this.expand.emit(event);
        }
        else {
            this.angularTreeGridService.emitExpandRowEvent(this.expand_tracker, this.expand, this.store, row_data, this.configs);
        }
    }
    onRowCollapse(event) {
        const row_data = event.data;
        this.expand_tracker[row_data.pathx] = false;
        // Collapse all of its children.
        const keys = Object.keys(this.expand_tracker);
        keys.forEach(key => {
            if (key.indexOf(row_data.pathx) !== -1) {
                this.expand_tracker[key] = 0;
            }
        });
        this.collapse.emit(event);
    }
    saveRecord($event) {
        const element = $event.data;
        if (this.configs.actions.resolve_edit) {
            const promise = new Promise((resolve, reject) => {
                this.rowsave.emit({
                    data: element,
                    resolve: resolve
                });
            });
            promise.then(() => {
                this.checkAndRefreshData(element);
            }).catch((err) => { });
        }
        else {
            this.checkAndRefreshData(element);
            this.rowsave.emit(element);
        }
    }
    checkAndRefreshData(element) {
        this.edit_tracker[element[this.configs.id_field]] = false;
        this.internal_configs.show_parent_col = false;
        // Only refresh if Parent has been changed.
        if (this.internal_configs.current_edited_row[this.configs.parent_id_field]
            !== element[this.configs.parent_id_field]) {
            this.refreshData(element);
        }
    }
    addRow(element) {
        if (this.configs.actions.resolve_add) {
            const promise = new Promise((resolve, reject) => {
                this.rowadd.emit({
                    data: element,
                    resolve: resolve
                });
            });
            promise.then(() => {
                this.internal_configs.show_add_row = false;
                this.refreshData(element);
            }).catch((err) => { });
        }
        else {
            this.refreshData(element);
            this.internal_configs.show_add_row = false;
            this.rowadd.emit(element);
        }
    }
    cancelEdit(row_data) {
        const index = row_data[this.configs.id_field];
        // Cancel all changes ie copy from back up.
        Object.assign(row_data, this.internal_configs.current_edited_row);
        this.edit_tracker[index] = false;
        this.internal_configs.show_parent_col = false;
    }
    selectRow(row_data, event) {
        // Don't run if Multi select is enabled.
        if (this.configs.multi_select) {
            return;
        }
        this.store.getDisplayData().forEach(data => {
            data.row_selected = false;
        });
        row_data.row_selected = true;
        this.rowselect.emit({ data: row_data, event: event });
    }
    selectRowOnCheck(row_data, event) {
        if (event.target.checked) {
            row_data.row_selected = true;
            this.rowselect.emit({ data: row_data, event: event });
        }
        else {
            row_data.row_selected = false;
            this.rowdeselect.emit({ data: row_data, event: event });
        }
        this.setSelectAllConfig();
    }
    /**
     * Set Select All config on Select change.
     *
     */
    setSelectAllConfig() {
        let select_all = true;
        this.store.getDisplayData().forEach(data => {
            if (!data.row_selected) {
                select_all = false;
            }
        });
        this.internal_configs.all_selected = select_all;
    }
}
TreeBodyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: TreeBodyComponent, deps: [{ token: i1.AngularTreeGridService }], target: i0.ɵɵFactoryTarget.Component });
TreeBodyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.2.1", type: TreeBodyComponent, selector: "[db-tree-body]", inputs: { store: "store", configs: "configs", expand_tracker: "expand_tracker", edit_tracker: "edit_tracker", internal_configs: "internal_configs", columns: "columns", cellclick: "cellclick", expand: "expand", collapse: "collapse", rowdelete: "rowdelete", rowsave: "rowsave", rowadd: "rowadd", rowselect: "rowselect", rowdeselect: "rowdeselect" }, ngImport: i0, template: "<ng-container *ngIf=\"configs\">\n<tr *ngIf=\"store.raw_data.length==0\">\n  <td [innerHTML]=\"configs.data_loading_text\" [attr.colspan]=\"columns.length + 1\" style=\"text-align: center\"></td>\n</tr>\n<tr db-filter-row \n  [columns]=\"columns\" \n  [configs]=\"configs\"\n  [store]=\"store\"\n  [internal_configs]=\"internal_configs\" \n  *ngIf=\"configs.filter\"\n  [expand_tracker]=\"expand_tracker\"\n  [ngClass]=\"configs.css.row_filter_class\">\n</tr>\n<tr db-add-row \n  [columns]=\"columns\" \n  [configs]=\"configs\" \n  [internal_configs]=\"internal_configs\" \n  [store]=\"store\"\n  (rowadd)=\"addRow($event)\"\n  *ngIf=\"internal_configs.show_add_row\"\n  [ngClass]=\"configs.row_class_function()\">\n</tr>\n<ng-container *ngIf=\"configs.subgrid\">\n  <tr db-subgrid\n  *ngFor=\"let row_data of display_data\"\n  class=\"subgrid-row\"\n  [configs]=\"configs\" \n  [internal_configs]=\"internal_configs\" \n  [expand_tracker]=\"expand_tracker\" \n  [edit_tracker]=\"edit_tracker\" \n  [store]=\"store\"\n  [row_data]=\"row_data\"\n  [cellclick]=\"cellclick\"\n  [rowselect]=\"rowselect\"\n  [rowdeselect]=\"rowdeselect\"\n  [expand]=\"expand\"\n  [rowsave]=\"rowsave\"\n  [rowdelete]=\"rowdelete\"\n  >\n\n  </tr>\n</ng-container>\n<ng-container *ngIf=\"!configs.subgrid\">\n  <tr \n  *ngFor=\"let row_data of display_data\"\n  [attr.class]=\"configs.row_class_function(row_data) + ' ' + (row_data.row_selected ? configs.css.row_selection_class : '')\"\n  (click)=\"selectRow(row_data, $event)\" \n  >  \n  <ng-container *ngIf=\"expand_tracker[row_data.parent_pathx]\">\n    <td *ngIf=\"configs.multi_select\" class=\"checkbox_column\">\n      <input type=\"checkbox\" [checked]=\"row_data.row_selected\" (click)=\"selectRowOnCheck(row_data, $event)\" \n        [attr.disabled]=\"row_data.selection_disabled\">\n    </td>\n    <td db-tree-cell-actions \n      *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"\n      [row_data]=\"row_data\"\n      [configs]=\"configs\"\n      [store]=\"store\"\n      [edit_tracker]=\"edit_tracker\"\n      [internal_configs]=\"internal_configs\"\n      [rowdelete]=\"rowdelete\"\n      (canceledit)=\"cancelEdit($event)\" \n      (editcomplete)=\"saveRecord($event)\">\n    </td>\n    <td *ngFor=\"let column of columns; index as i\" \n    class=\"{{column.css_class}}\"\n    [ngClass]=\"{'column-hide': column.hidden, 'expand-column': i == 0}\">\n      <db-tree-cell\n        [configs]=\"configs\"\n        [column]=\"column\"\n        [index]=\"i\"\n        [row_data]=\"row_data\"\n        [expand_tracker]=\"expand_tracker\"\n        [edit_on]=\"edit_tracker[row_data[configs.id_field]]\"\n        [cellclick]=\"cellclick\"\n        (rowexpand)=\"onRowExpand($event)\"\n        (rowcollapse)=\"onRowCollapse($event)\"\n        (editcomplete)=\"saveRecord($event)\"\n      >\n      </db-tree-cell>\n    </td>\n    <td *ngIf=\"configs.show_parent_on_edit && internal_configs.show_parent_col\">\n      <select *ngIf=\"edit_tracker[row_data[configs.id_field]]\" \n        [(ngModel)]=\"row_data[configs.parent_id_field]\">\n        <option *ngFor=\"let parent of parents\" [value]=\"parent.id\">{{parent.value}}</option>\n      </select>\n    </td>    \n\n    <!-- Add column to fix UI issue when add row is enabled but don't show when edit is enabled for the row -->\n    <td *ngIf=\"internal_configs.show_add_row && !(internal_configs.show_parent_col && configs.show_parent_on_edit)\"></td>\n  </ng-container>\n</tr>\n<tr *ngIf=\"configs.show_summary_row\">\n  <td *ngIf=\"configs.multi_select\"></td>\n  <td *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"></td>\n  <td *ngFor=\"let column of configs.columns\">\n    <div [innerHTML]=\"column.summary_renderer && column.summary_renderer(display_data)\"></div>\n  </td>\n</tr>\n</ng-container>\n\n</ng-container>\n", styles: [".db-tree-view{line-height:1.5em;border-collapse:collapse;border-spacing:0;display:table;max-width:100%;overflow:auto;word-break:normal;word-break:keep-all;color:#4b4b4b}tr{border-bottom:1px solid #cdd5dc}tr.selected{background-color:#e2e7eb}tr span.parent_container{padding-left:45px}tr.child{background:#fff}tr.child td:nth-child(2){padding:.875rem 1.25rem .875rem 2.5rem!important}tr.parent{background:#fafbff}tr.subgrid-row{background:#fcfcfc}tr td{vertical-align:middle;position:relative;padding:.5rem;box-sizing:border-box}tr td.checkbox_column{text-align:center}tr td.expand-column{padding:.3rem}tr td.column-hide{display:none}tr td.clear-left-border{border-left:0!important}tr td.clear-right-border{border-right:0!important}tr td select{padding:5px;border:1px solid #d1cece}\n"], components: [{ type: i2.FilterRowComponent, selector: "[db-filter-row]", inputs: ["store", "columns", "expand_tracker", "configs", "internal_configs"] }, { type: i3.AddRowComponent, selector: "[db-add-row]", inputs: ["store", "columns", "configs", "internal_configs"], outputs: ["rowadd", "canceledit"] }, { type: i4.SubgridComponent, selector: "[db-subgrid]", inputs: ["store", "configs", "expand_tracker", "edit_tracker", "internal_configs", "row_data", "cellclick", "expand", "rowselect", "rowdeselect", "rowsave", "rowdelete"] }, { type: i5.TreeCellActionsComponent, selector: "[db-tree-cell-actions]", inputs: ["store", "edit_tracker", "internal_configs", "configs", "rowdelete", "row_data"], outputs: ["editcomplete", "canceledit"] }, { type: i6.TreeCellComponent, selector: "db-tree-cell", inputs: ["configs", "index", "row_data", "column", "expand_tracker", "cellclick", "edit_on"], outputs: ["rowexpand", "rowcollapse", "canceledit", "editcomplete"] }], directives: [{ type: i7.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i7.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { type: i7.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i8.SelectControlValueAccessor, selector: "select:not([multiple])[formControlName],select:not([multiple])[formControl],select:not([multiple])[ngModel]", inputs: ["compareWith"] }, { type: i8.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i8.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { type: i8.NgSelectOption, selector: "option", inputs: ["ngValue", "value"] }, { type: i8.ɵNgSelectMultipleOption, selector: "option", inputs: ["ngValue", "value"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: TreeBodyComponent, decorators: [{
            type: Component,
            args: [{ selector: '[db-tree-body]', template: "<ng-container *ngIf=\"configs\">\n<tr *ngIf=\"store.raw_data.length==0\">\n  <td [innerHTML]=\"configs.data_loading_text\" [attr.colspan]=\"columns.length + 1\" style=\"text-align: center\"></td>\n</tr>\n<tr db-filter-row \n  [columns]=\"columns\" \n  [configs]=\"configs\"\n  [store]=\"store\"\n  [internal_configs]=\"internal_configs\" \n  *ngIf=\"configs.filter\"\n  [expand_tracker]=\"expand_tracker\"\n  [ngClass]=\"configs.css.row_filter_class\">\n</tr>\n<tr db-add-row \n  [columns]=\"columns\" \n  [configs]=\"configs\" \n  [internal_configs]=\"internal_configs\" \n  [store]=\"store\"\n  (rowadd)=\"addRow($event)\"\n  *ngIf=\"internal_configs.show_add_row\"\n  [ngClass]=\"configs.row_class_function()\">\n</tr>\n<ng-container *ngIf=\"configs.subgrid\">\n  <tr db-subgrid\n  *ngFor=\"let row_data of display_data\"\n  class=\"subgrid-row\"\n  [configs]=\"configs\" \n  [internal_configs]=\"internal_configs\" \n  [expand_tracker]=\"expand_tracker\" \n  [edit_tracker]=\"edit_tracker\" \n  [store]=\"store\"\n  [row_data]=\"row_data\"\n  [cellclick]=\"cellclick\"\n  [rowselect]=\"rowselect\"\n  [rowdeselect]=\"rowdeselect\"\n  [expand]=\"expand\"\n  [rowsave]=\"rowsave\"\n  [rowdelete]=\"rowdelete\"\n  >\n\n  </tr>\n</ng-container>\n<ng-container *ngIf=\"!configs.subgrid\">\n  <tr \n  *ngFor=\"let row_data of display_data\"\n  [attr.class]=\"configs.row_class_function(row_data) + ' ' + (row_data.row_selected ? configs.css.row_selection_class : '')\"\n  (click)=\"selectRow(row_data, $event)\" \n  >  \n  <ng-container *ngIf=\"expand_tracker[row_data.parent_pathx]\">\n    <td *ngIf=\"configs.multi_select\" class=\"checkbox_column\">\n      <input type=\"checkbox\" [checked]=\"row_data.row_selected\" (click)=\"selectRowOnCheck(row_data, $event)\" \n        [attr.disabled]=\"row_data.selection_disabled\">\n    </td>\n    <td db-tree-cell-actions \n      *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"\n      [row_data]=\"row_data\"\n      [configs]=\"configs\"\n      [store]=\"store\"\n      [edit_tracker]=\"edit_tracker\"\n      [internal_configs]=\"internal_configs\"\n      [rowdelete]=\"rowdelete\"\n      (canceledit)=\"cancelEdit($event)\" \n      (editcomplete)=\"saveRecord($event)\">\n    </td>\n    <td *ngFor=\"let column of columns; index as i\" \n    class=\"{{column.css_class}}\"\n    [ngClass]=\"{'column-hide': column.hidden, 'expand-column': i == 0}\">\n      <db-tree-cell\n        [configs]=\"configs\"\n        [column]=\"column\"\n        [index]=\"i\"\n        [row_data]=\"row_data\"\n        [expand_tracker]=\"expand_tracker\"\n        [edit_on]=\"edit_tracker[row_data[configs.id_field]]\"\n        [cellclick]=\"cellclick\"\n        (rowexpand)=\"onRowExpand($event)\"\n        (rowcollapse)=\"onRowCollapse($event)\"\n        (editcomplete)=\"saveRecord($event)\"\n      >\n      </db-tree-cell>\n    </td>\n    <td *ngIf=\"configs.show_parent_on_edit && internal_configs.show_parent_col\">\n      <select *ngIf=\"edit_tracker[row_data[configs.id_field]]\" \n        [(ngModel)]=\"row_data[configs.parent_id_field]\">\n        <option *ngFor=\"let parent of parents\" [value]=\"parent.id\">{{parent.value}}</option>\n      </select>\n    </td>    \n\n    <!-- Add column to fix UI issue when add row is enabled but don't show when edit is enabled for the row -->\n    <td *ngIf=\"internal_configs.show_add_row && !(internal_configs.show_parent_col && configs.show_parent_on_edit)\"></td>\n  </ng-container>\n</tr>\n<tr *ngIf=\"configs.show_summary_row\">\n  <td *ngIf=\"configs.multi_select\"></td>\n  <td *ngIf=\"(configs.actions.edit || configs.actions.delete || configs.actions.add)\"></td>\n  <td *ngFor=\"let column of configs.columns\">\n    <div [innerHTML]=\"column.summary_renderer && column.summary_renderer(display_data)\"></div>\n  </td>\n</tr>\n</ng-container>\n\n</ng-container>\n", styles: [".db-tree-view{line-height:1.5em;border-collapse:collapse;border-spacing:0;display:table;max-width:100%;overflow:auto;word-break:normal;word-break:keep-all;color:#4b4b4b}tr{border-bottom:1px solid #cdd5dc}tr.selected{background-color:#e2e7eb}tr span.parent_container{padding-left:45px}tr.child{background:#fff}tr.child td:nth-child(2){padding:.875rem 1.25rem .875rem 2.5rem!important}tr.parent{background:#fafbff}tr.subgrid-row{background:#fcfcfc}tr td{vertical-align:middle;position:relative;padding:.5rem;box-sizing:border-box}tr td.checkbox_column{text-align:center}tr td.expand-column{padding:.3rem}tr td.column-hide{display:none}tr td.clear-left-border{border-left:0!important}tr td.clear-right-border{border-right:0!important}tr td select{padding:5px;border:1px solid #d1cece}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.AngularTreeGridService }]; }, propDecorators: { store: [{
                type: Input
            }], configs: [{
                type: Input
            }], expand_tracker: [{
                type: Input
            }], edit_tracker: [{
                type: Input
            }], internal_configs: [{
                type: Input
            }], columns: [{
                type: Input
            }], cellclick: [{
                type: Input
            }], expand: [{
                type: Input
            }], collapse: [{
                type: Input
            }], rowdelete: [{
                type: Input
            }], rowsave: [{
                type: Input
            }], rowadd: [{
                type: Input
            }], rowselect: [{
                type: Input
            }], rowdeselect: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ib2R5LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItdHJlZS1ncmlkL3NyYy9saWIvbW9kdWxlcy90cmVlLWJvZHkvdHJlZS1ib2R5LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItdHJlZS1ncmlkL3NyYy9saWIvbW9kdWxlcy90cmVlLWJvZHkvdHJlZS1ib2R5LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsS0FBSyxFQUFnQixNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7OztBQVd2RSxNQUFNLE9BQU8saUJBQWlCO0lBK0M1QixZQUFvQixzQkFBOEM7UUFBOUMsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQTlDbEUsWUFBTyxHQUFVLEVBQUUsQ0FBQztJQStDcEIsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDaEQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLHdCQUF3QixDQUFDLFNBQVMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ3ZFLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNoRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFFcEIsQ0FBQztJQUVELFVBQVU7UUFDUixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FDcEMsT0FBTyxDQUFDLEVBQUU7WUFDUixPQUFPO2dCQUNMLElBQUksRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8s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QURMLEtBQUs7Z0JBSU4sUUFBUTtzQkFEUCxLQUFLO2dCQUlOLFNBQVM7c0JBRFIsS0FBSztnQkFJTixPQUFPO3NCQUROLEtBQUs7Z0JBSU4sTUFBTTtzQkFETCxLQUFLO2dCQUlOLFNBQVM7c0JBRFIsS0FBSztnQkFJTixXQUFXO3NCQURWLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgSW5wdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29uZmlncyB9IGZyb20gJy4uLy4uL21vZGVscy9Db25maWdzLm1vZGVsJztcbmltcG9ydCB7IENvbHVtbiB9IGZyb20gJy4uLy4uL21vZGVscy9Db2x1bW4ubW9kZWwnO1xuaW1wb3J0IHsgQW5ndWxhclRyZWVHcmlkU2VydmljZSB9IGZyb20gJy4uLy4uL2FuZ3VsYXItdHJlZS1ncmlkLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICcuLi8uLi9zdG9yZS9zdG9yZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ1tkYi10cmVlLWJvZHldJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RyZWUtYm9keS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3RyZWUtYm9keS5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIFRyZWVCb2R5Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgcGFyZW50czogYW55W10gPSBbXTtcbiAgcmF3X2RhdGE6IGFueVtdO1xuICBkaXNwbGF5X2RhdGE6IGFueVtdO1xuXG4gIEBJbnB1dCgpXG4gIHN0b3JlOiBTdG9yZTtcblxuICBASW5wdXQoKVxuICBjb25maWdzOiBDb25maWdzO1xuXG4gIEBJbnB1dCgpXG4gIGV4cGFuZF90cmFja2VyOiBhbnk7XG5cbiAgQElucHV0KClcbiAgZWRpdF90cmFja2VyOiBhbnk7XG5cbiAgQElucHV0KClcbiAgaW50ZXJuYWxfY29uZmlnczogYW55O1xuXG4gIEBJbnB1dCgpXG4gIGNvbHVtbnM6IENvbHVtbltdO1xuXG4gIEBJbnB1dCgpXG4gIGNlbGxjbGljazogRXZlbnRFbWl0dGVyPGFueT47XG5cbiAgQElucHV0KClcbiAgZXhwYW5kOiBFdmVudEVtaXR0ZXI8YW55PjtcblxuICBASW5wdXQoKVxuICBjb2xsYXBzZTogRXZlbnRFbWl0dGVyPGFueT47XG5cbiAgQElucHV0KClcbiAgcm93ZGVsZXRlOiBFdmVudEVtaXR0ZXI8YW55PjtcblxuICBASW5wdXQoKVxuICByb3dzYXZlOiBFdmVudEVtaXR0ZXI8YW55PjtcblxuICBASW5wdXQoKVxuICByb3dhZGQ6IEV2ZW50RW1pdHRlcjxhbnk+O1xuXG4gIEBJbnB1dCgpXG4gIHJvd3NlbGVjdDogRXZlbnRFbWl0dGVyPGFueT47XG5cbiAgQElucHV0KClcbiAgcm93ZGVzZWxlY3Q6IEV2ZW50RW1pdHRlcjxhbnk+O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYW5ndWxhclRyZWVHcmlkU2VydmljZTogQW5ndWxhclRyZWVHcmlkU2VydmljZSkge1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5kaXNwbGF5X2RhdGEgPSB0aGlzLnN0b3JlLmdldERpc3BsYXlEYXRhKCk7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmRpc3BsYXlfZGF0YV9vYnNlcnZhYmxlJC5zdWJzY3JpYmUoKHN0b3JlKSA9PiB7XG4gICAgICB0aGlzLmRpc3BsYXlfZGF0YSA9IHRoaXMuc3RvcmUuZ2V0RGlzcGxheURhdGEoKTtcbiAgICAgIHRoaXMuc2V0UGFyZW50cygpO1xuICAgIH0pO1xuICAgIHRoaXMuc2V0UGFyZW50cygpO1xuXG4gIH1cblxuICBzZXRQYXJlbnRzKCkge1xuICAgIHRoaXMucGFyZW50cyA9IHRoaXMuc3RvcmUucmF3X2RhdGEubWFwKFxuICAgICAgZWxlbWVudCA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgJ2lkJzogZWxlbWVudFt0aGlzLmNvbmZpZ3MuaWRfZmllbGRdLFxuICAgICAgICAgICd2YWx1ZSc6IGVsZW1lbnRbdGhpcy5jb25maWdzLnBhcmVudF9kaXNwbGF5X2ZpZWxkXVxuICAgICAgICB9O1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICByZWZyZXNoRGF0YShlbGVtZW50KSB7XG4gICAgLy8gSWYgZWRpdCBwYXJlbnQgaXMgbm90IHRydWUgdGhlbiBkb24ndCByZWZyZXNoLlxuICAgIGlmICghdGhpcy5jb25maWdzLmFjdGlvbnMuZWRpdF9wYXJlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZWxlbWVudFt0aGlzLmNvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSA9IHBhcnNlSW50KGVsZW1lbnRbdGhpcy5jb25maWdzLnBhcmVudF9pZF9maWVsZF0sIDEwKTtcbiAgICB0aGlzLmV4cGFuZF90cmFja2VyID0ge307XG4gICAgdGhpcy5lZGl0X3RyYWNrZXIgPSB7fTtcbiAgICB0aGlzLnN0b3JlLnByb2Nlc3NEYXRhKFxuICAgICAgdGhpcy5zdG9yZS5nZXRSYXdEYXRhKCksXG4gICAgICB0aGlzLmV4cGFuZF90cmFja2VyLFxuICAgICAgdGhpcy5jb25maWdzLFxuICAgICAgdGhpcy5lZGl0X3RyYWNrZXIsXG4gICAgICB0aGlzLmludGVybmFsX2NvbmZpZ3NcbiAgICApO1xuICB9XG5cbiAgb25Sb3dFeHBhbmQoZXZlbnQpIHtcbiAgICBjb25zdCByb3dfZGF0YSA9IGV2ZW50LmRhdGE7XG5cbiAgICBpZiAoIXRoaXMuY29uZmlncy5sb2FkX2NoaWxkcmVuX29uX2V4cGFuZCkge1xuICAgICAgdGhpcy5leHBhbmRfdHJhY2tlcltyb3dfZGF0YS5wYXRoeF0gPSB0cnVlO1xuICAgICAgdGhpcy5leHBhbmQuZW1pdChldmVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYW5ndWxhclRyZWVHcmlkU2VydmljZS5lbWl0RXhwYW5kUm93RXZlbnQodGhpcy5leHBhbmRfdHJhY2tlciwgdGhpcy5leHBhbmQsIHRoaXMuc3RvcmUsIHJvd19kYXRhLCB0aGlzLmNvbmZpZ3MpO1xuICAgIH1cbiAgfVxuXG4gIG9uUm93Q29sbGFwc2UoZXZlbnQpIHtcbiAgICBjb25zdCByb3dfZGF0YSA9IGV2ZW50LmRhdGE7XG4gICAgdGhpcy5leHBhbmRfdHJhY2tlcltyb3dfZGF0YS5wYXRoeF0gPSBmYWxzZTtcblxuICAgIC8vIENvbGxhcHNlIGFsbCBvZiBpdHMgY2hpbGRyZW4uXG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuZXhwYW5kX3RyYWNrZXIpO1xuICAgIGtleXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKGtleS5pbmRleE9mKHJvd19kYXRhLnBhdGh4KSAhPT0gLTEpIHtcbiAgICAgICAgdGhpcy5leHBhbmRfdHJhY2tlcltrZXldID0gMDtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMuY29sbGFwc2UuZW1pdChldmVudCk7XG4gIH1cblxuICBzYXZlUmVjb3JkKCRldmVudCkge1xuICAgIGNvbnN0IGVsZW1lbnQgPSAkZXZlbnQuZGF0YTtcblxuICAgIGlmICh0aGlzLmNvbmZpZ3MuYWN0aW9ucy5yZXNvbHZlX2VkaXQpIHtcbiAgICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHRoaXMucm93c2F2ZS5lbWl0KHtcbiAgICAgICAgICBkYXRhOiBlbGVtZW50LFxuICAgICAgICAgIHJlc29sdmU6IHJlc29sdmVcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgcHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5jaGVja0FuZFJlZnJlc2hEYXRhKGVsZW1lbnQpO1xuICAgICAgfSkuY2F0Y2goKGVycikgPT4ge30pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNoZWNrQW5kUmVmcmVzaERhdGEoZWxlbWVudCk7XG4gICAgICB0aGlzLnJvd3NhdmUuZW1pdChlbGVtZW50KTtcbiAgICB9XG4gIH1cblxuICBjaGVja0FuZFJlZnJlc2hEYXRhKGVsZW1lbnQpIHtcbiAgICB0aGlzLmVkaXRfdHJhY2tlcltlbGVtZW50W3RoaXMuY29uZmlncy5pZF9maWVsZF1dID0gZmFsc2U7XG4gICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLnNob3dfcGFyZW50X2NvbCA9IGZhbHNlO1xuXG4gICAgLy8gT25seSByZWZyZXNoIGlmIFBhcmVudCBoYXMgYmVlbiBjaGFuZ2VkLlxuICAgIGlmICh0aGlzLmludGVybmFsX2NvbmZpZ3MuY3VycmVudF9lZGl0ZWRfcm93W3RoaXMuY29uZmlncy5wYXJlbnRfaWRfZmllbGRdXG4gICAgICAhPT0gZWxlbWVudFt0aGlzLmNvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSkge1xuICAgICAgICB0aGlzLnJlZnJlc2hEYXRhKGVsZW1lbnQpO1xuICAgIH1cbiAgfVxuXG4gIGFkZFJvdyhlbGVtZW50KSB7XG4gICAgaWYgKHRoaXMuY29uZmlncy5hY3Rpb25zLnJlc29sdmVfYWRkKSB7XG4gICAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICB0aGlzLnJvd2FkZC5lbWl0KHtcbiAgICAgICAgICBkYXRhOiBlbGVtZW50LFxuICAgICAgICAgIHJlc29sdmU6IHJlc29sdmVcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgcHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLnNob3dfYWRkX3JvdyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlZnJlc2hEYXRhKGVsZW1lbnQpO1xuICAgICAgfSkuY2F0Y2goKGVycikgPT4ge30pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlZnJlc2hEYXRhKGVsZW1lbnQpO1xuICAgICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLnNob3dfYWRkX3JvdyA9IGZhbHNlO1xuICAgICAgdGhpcy5yb3dhZGQuZW1pdChlbGVtZW50KTtcbiAgICB9XG4gIH1cblxuICBjYW5jZWxFZGl0KHJvd19kYXRhKSB7XG4gICAgY29uc3QgaW5kZXggPSByb3dfZGF0YVt0aGlzLmNvbmZpZ3MuaWRfZmllbGRdO1xuXG4gICAgLy8gQ2FuY2VsIGFsbCBjaGFuZ2VzIGllIGNvcHkgZnJvbSBiYWNrIHVwLlxuICAgIE9iamVjdC5hc3NpZ24ocm93X2RhdGEsIHRoaXMuaW50ZXJuYWxfY29uZmlncy5jdXJyZW50X2VkaXRlZF9yb3cpO1xuXG4gICAgdGhpcy5lZGl0X3RyYWNrZXJbaW5kZXhdID0gZmFsc2U7XG4gICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLnNob3dfcGFyZW50X2NvbCA9IGZhbHNlO1xuICB9XG5cbiAgc2VsZWN0Um93KHJvd19kYXRhLCBldmVudCkge1xuXG4gICAgLy8gRG9uJ3QgcnVuIGlmIE11bHRpIHNlbGVjdCBpcyBlbmFibGVkLlxuICAgIGlmICh0aGlzLmNvbmZpZ3MubXVsdGlfc2VsZWN0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zdG9yZS5nZXREaXNwbGF5RGF0YSgpLmZvckVhY2goZGF0YSA9PiB7XG4gICAgICBkYXRhLnJvd19zZWxlY3RlZCA9IGZhbHNlO1xuICAgIH0pO1xuICAgIHJvd19kYXRhLnJvd19zZWxlY3RlZCA9IHRydWU7XG4gICAgdGhpcy5yb3dzZWxlY3QuZW1pdCh7ZGF0YTogcm93X2RhdGEsIGV2ZW50OiBldmVudH0pO1xuICB9XG5cbiAgc2VsZWN0Um93T25DaGVjayhyb3dfZGF0YSwgZXZlbnQpIHtcbiAgICBpZiAoZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHtcbiAgICAgIHJvd19kYXRhLnJvd19zZWxlY3RlZCA9IHRydWU7XG4gICAgICB0aGlzLnJvd3NlbGVjdC5lbWl0KHtkYXRhOiByb3dfZGF0YSwgZXZlbnQ6IGV2ZW50fSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJvd19kYXRhLnJvd19zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5yb3dkZXNlbGVjdC5lbWl0KHtkYXRhOiByb3dfZGF0YSwgZXZlbnQ6IGV2ZW50fSk7XG4gICAgfVxuXG4gICAgdGhpcy5zZXRTZWxlY3RBbGxDb25maWcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgU2VsZWN0IEFsbCBjb25maWcgb24gU2VsZWN0IGNoYW5nZS5cbiAgICpcbiAgICovXG4gIHNldFNlbGVjdEFsbENvbmZpZygpIHtcbiAgICBsZXQgc2VsZWN0X2FsbCA9IHRydWU7XG5cbiAgICB0aGlzLnN0b3JlLmdldERpc3BsYXlEYXRhKCkuZm9yRWFjaChkYXRhID0+IHtcbiAgICAgIGlmICghZGF0YS5yb3dfc2VsZWN0ZWQpIHtcbiAgICAgICAgc2VsZWN0X2FsbCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLmFsbF9zZWxlY3RlZCA9IHNlbGVjdF9hbGw7XG5cbiAgfVxuXG59XG4iLCI8bmctY29udGFpbmVyICpuZ0lmPVwiY29uZmlnc1wiPlxuPHRyICpuZ0lmPVwic3RvcmUucmF3X2RhdGEubGVuZ3RoPT0wXCI+XG4gIDx0ZCBbaW5uZXJIVE1MXT1cImNvbmZpZ3MuZGF0YV9sb2FkaW5nX3RleHRcIiBbYXR0ci5jb2xzcGFuXT1cImNvbHVtbnMubGVuZ3RoICsgMVwiIHN0eWxlPVwidGV4dC1hbGlnbjogY2VudGVyXCI+PC90ZD5cbjwvdHI+XG48dHIgZGItZmlsdGVyLXJvdyBcbiAgW2NvbHVtbnNdPVwiY29sdW1uc1wiIFxuICBbY29uZmlnc109XCJjb25maWdzXCJcbiAgW3N0b3JlXT1cInN0b3JlXCJcbiAgW2ludGVybmFsX2NvbmZpZ3NdPVwiaW50ZXJuYWxfY29uZmlnc1wiIFxuICAqbmdJZj1cImNvbmZpZ3MuZmlsdGVyXCJcbiAgW2V4cGFuZF90cmFja2VyXT1cImV4cGFuZF90cmFja2VyXCJcbiAgW25nQ2xhc3NdPVwiY29uZmlncy5jc3Mucm93X2ZpbHRlcl9jbGFzc1wiPlxuPC90cj5cbjx0ciBkYi1hZGQtcm93IFxuICBbY29sdW1uc109XCJjb2x1bW5zXCIgXG4gIFtjb25maWdzXT1cImNvbmZpZ3NcIiBcbiAgW2ludGVybmFsX2NvbmZpZ3NdPVwiaW50ZXJuYWxfY29uZmlnc1wiIFxuICBbc3RvcmVdPVwic3RvcmVcIlxuICAocm93YWRkKT1cImFkZFJvdygkZXZlbnQpXCJcbiAgKm5nSWY9XCJpbnRlcm5hbF9jb25maWdzLnNob3dfYWRkX3Jvd1wiXG4gIFtuZ0NsYXNzXT1cImNvbmZpZ3Mucm93X2NsYXNzX2Z1bmN0aW9uKClcIj5cbjwvdHI+XG48bmctY29udGFpbmVyICpuZ0lmPVwiY29uZmlncy5zdWJncmlkXCI+XG4gIDx0ciBkYi1zdWJncmlkXG4gICpuZ0Zvcj1cImxldCByb3dfZGF0YSBvZiBkaXNwbGF5X2RhdGFcIlxuICBjbGFzcz1cInN1YmdyaWQtcm93XCJcbiAgW2NvbmZpZ3NdPVwiY29uZmlnc1wiIFxuICBbaW50ZXJuYWxfY29uZmlnc109XCJpbnRlcm5hbF9jb25maWdzXCIgXG4gIFtleHBhbmRfdHJhY2tlcl09XCJleHBhbmRfdHJhY2tlclwiIFxuICBbZWRpdF90cmFja2VyXT1cImVkaXRfdHJhY2tlclwiIFxuICBbc3RvcmVdPVwic3RvcmVcIlxuICBbcm93X2RhdGFdPVwicm93X2RhdGFcIlxuICBbY2VsbGNsaWNrXT1cImNlbGxjbGlja1wiXG4gIFtyb3dzZWxlY3RdPVwicm93c2VsZWN0XCJcbiAgW3Jvd2Rlc2VsZWN0XT1cInJvd2Rlc2VsZWN0XCJcbiAgW2V4cGFuZF09XCJleHBhbmRcIlxuICBbcm93c2F2ZV09XCJyb3dzYXZlXCJcbiAgW3Jvd2RlbGV0ZV09XCJyb3dkZWxldGVcIlxuICA+XG5cbiAgPC90cj5cbjwvbmctY29udGFpbmVyPlxuPG5nLWNvbnRhaW5lciAqbmdJZj1cIiFjb25maWdzLnN1YmdyaWRcIj5cbiAgPHRyIFxuICAqbmdGb3I9XCJsZXQgcm93X2RhdGEgb2YgZGlzcGxheV9kYXRhXCJcbiAgW2F0dHIuY2xhc3NdPVwiY29uZmlncy5yb3dfY2xhc3NfZnVuY3Rpb24ocm93X2RhdGEpICsgJyAnICsgKHJvd19kYXRhLnJvd19zZWxlY3RlZCA/IGNvbmZpZ3MuY3NzLnJvd19zZWxlY3Rpb25fY2xhc3MgOiAnJylcIlxuICAoY2xpY2spPVwic2VsZWN0Um93KHJvd19kYXRhLCAkZXZlbnQpXCIgXG4gID4gIFxuICA8bmctY29udGFpbmVyICpuZ0lmPVwiZXhwYW5kX3RyYWNrZXJbcm93X2RhdGEucGFyZW50X3BhdGh4XVwiPlxuICAgIDx0ZCAqbmdJZj1cImNvbmZpZ3MubXVsdGlfc2VsZWN0XCIgY2xhc3M9XCJjaGVja2JveF9jb2x1bW5cIj5cbiAgICAgIDxpbnB1dCB0eXBlPVwiY2hlY2tib3hcIiBbY2hlY2tlZF09XCJyb3dfZGF0YS5yb3dfc2VsZWN0ZWRcIiAoY2xpY2spPVwic2VsZWN0Um93T25DaGVjayhyb3dfZGF0YSwgJGV2ZW50KVwiIFxuICAgICAgICBbYXR0ci5kaXNhYmxlZF09XCJyb3dfZGF0YS5zZWxlY3Rpb25fZGlzYWJsZWRcIj5cbiAgICA8L3RkPlxuICAgIDx0ZCBkYi10cmVlLWNlbGwtYWN0aW9ucyBcbiAgICAgICpuZ0lmPVwiKGNvbmZpZ3MuYWN0aW9ucy5lZGl0IHx8IGNvbmZpZ3MuYWN0aW9ucy5kZWxldGUgfHwgY29uZmlncy5hY3Rpb25zLmFkZClcIlxuICAgICAgW3Jvd19kYXRhXT1cInJvd19kYXRhXCJcbiAgICAgIFtjb25maWdzXT1cImNvbmZpZ3NcIlxuICAgICAgW3N0b3JlXT1cInN0b3JlXCJcbiAgICAgIFtlZGl0X3RyYWNrZXJdPVwiZWRpdF90cmFja2VyXCJcbiAgICAgIFtpbnRlcm5hbF9jb25maWdzXT1cImludGVybmFsX2NvbmZpZ3NcIlxuICAgICAgW3Jvd2RlbGV0ZV09XCJyb3dkZWxldGVcIlxuICAgICAgKGNhbmNlbGVkaXQpPVwiY2FuY2VsRWRpdCgkZXZlbnQpXCIgXG4gICAgICAoZWRpdGNvbXBsZXRlKT1cInNhdmVSZWNvcmQoJGV2ZW50KVwiPlxuICAgIDwvdGQ+XG4gICAgPHRkICpuZ0Zvcj1cImxldCBjb2x1bW4gb2YgY29sdW1uczsgaW5kZXggYXMgaVwiIFxuICAgIGNsYXNzPVwie3tjb2x1bW4uY3NzX2NsYXNzfX1cIlxuICAgIFtuZ0NsYXNzXT1cInsnY29sdW1uLWhpZGUnOiBjb2x1bW4uaGlkZGVuLCAnZXhwYW5kLWNvbHVtbic6IGkgPT0gMH1cIj5cbiAgICAgIDxkYi10cmVlLWNlbGxcbiAgICAgICAgW2NvbmZpZ3NdPVwiY29uZmlnc1wiXG4gICAgICAgIFtjb2x1bW5dPVwiY29sdW1uXCJcbiAgICAgICAgW2luZGV4XT1cImlcIlxuICAgICAgICBbcm93X2RhdGFdPVwicm93X2RhdGFcIlxuICAgICAgICBbZXhwYW5kX3RyYWNrZXJdPVwiZXhwYW5kX3RyYWNrZXJcIlxuICAgICAgICBbZWRpdF9vbl09XCJlZGl0X3RyYWNrZXJbcm93X2RhdGFbY29uZmlncy5pZF9maWVsZF1dXCJcbiAgICAgICAgW2NlbGxjbGlja109XCJjZWxsY2xpY2tcIlxuICAgICAgICAocm93ZXhwYW5kKT1cIm9uUm93RXhwYW5kKCRldmVudClcIlxuICAgICAgICAocm93Y29sbGFwc2UpPVwib25Sb3dDb2xsYXBzZSgkZXZlbnQpXCJcbiAgICAgICAgKGVkaXRjb21wbGV0ZSk9XCJzYXZlUmVjb3JkKCRldmVudClcIlxuICAgICAgPlxuICAgICAgPC9kYi10cmVlLWNlbGw+XG4gICAgPC90ZD5cbiAgICA8dGQgKm5nSWY9XCJjb25maWdzLnNob3dfcGFyZW50X29uX2VkaXQgJiYgaW50ZXJuYWxfY29uZmlncy5zaG93X3BhcmVudF9jb2xcIj5cbiAgICAgIDxzZWxlY3QgKm5nSWY9XCJlZGl0X3RyYWNrZXJbcm93X2RhdGFbY29uZmlncy5pZF9maWVsZF1dXCIgXG4gICAgICAgIFsobmdNb2RlbCldPVwicm93X2RhdGFbY29uZmlncy5wYXJlbnRfaWRfZmllbGRdXCI+XG4gICAgICAgIDxvcHRpb24gKm5nRm9yPVwibGV0IHBhcmVudCBvZiBwYXJlbnRzXCIgW3ZhbHVlXT1cInBhcmVudC5pZFwiPnt7cGFyZW50LnZhbHVlfX08L29wdGlvbj5cbiAgICAgIDwvc2VsZWN0PlxuICAgIDwvdGQ+ICAgIFxuXG4gICAgPCEtLSBBZGQgY29sdW1uIHRvIGZpeCBVSSBpc3N1ZSB3aGVuIGFkZCByb3cgaXMgZW5hYmxlZCBidXQgZG9uJ3Qgc2hvdyB3aGVuIGVkaXQgaXMgZW5hYmxlZCBmb3IgdGhlIHJvdyAtLT5cbiAgICA8dGQgKm5nSWY9XCJpbnRlcm5hbF9jb25maWdzLnNob3dfYWRkX3JvdyAmJiAhKGludGVybmFsX2NvbmZpZ3Muc2hvd19wYXJlbnRfY29sICYmIGNvbmZpZ3Muc2hvd19wYXJlbnRfb25fZWRpdClcIj48L3RkPlxuICA8L25nLWNvbnRhaW5lcj5cbjwvdHI+XG48dHIgKm5nSWY9XCJjb25maWdzLnNob3dfc3VtbWFyeV9yb3dcIj5cbiAgPHRkICpuZ0lmPVwiY29uZmlncy5tdWx0aV9zZWxlY3RcIj48L3RkPlxuICA8dGQgKm5nSWY9XCIoY29uZmlncy5hY3Rpb25zLmVkaXQgfHwgY29uZmlncy5hY3Rpb25zLmRlbGV0ZSB8fCBjb25maWdzLmFjdGlvbnMuYWRkKVwiPjwvdGQ+XG4gIDx0ZCAqbmdGb3I9XCJsZXQgY29sdW1uIG9mIGNvbmZpZ3MuY29sdW1uc1wiPlxuICAgIDxkaXYgW2lubmVySFRNTF09XCJjb2x1bW4uc3VtbWFyeV9yZW5kZXJlciAmJiBjb2x1bW4uc3VtbWFyeV9yZW5kZXJlcihkaXNwbGF5X2RhdGEpXCI+PC9kaXY+XG4gIDwvdGQ+XG48L3RyPlxuPC9uZy1jb250YWluZXI+XG5cbjwvbmctY29udGFpbmVyPlxuIl19