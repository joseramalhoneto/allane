import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import * as i0 from "@angular/core";
export class AngularTreeGridService {
    constructor() {
        this.display_data_observable = new Subject();
        this.display_data_observable$ = this.display_data_observable.asObservable();
    }
    updateDisplayDataObservable(display_data) {
        this.display_data_observable.next(display_data);
    }
    findRowIndex(display_data, configs, row_id) {
        return display_data.map(row => row[configs.id_field]).
            indexOf(row_id);
    }
    selectAll(display_data) {
        display_data.forEach(data => {
            data.row_selected = true;
        });
    }
    deSelectAll(display_data) {
        display_data.forEach(data => {
            data.row_selected = false;
        });
    }
    expandAll(expand_tracker) {
        for (const key in expand_tracker) {
            if (expand_tracker.hasOwnProperty(key)) {
                expand_tracker[key] = true;
            }
        }
    }
    collapseAll(expand_tracker) {
        for (const key in expand_tracker) {
            if (expand_tracker.hasOwnProperty(key)) {
                expand_tracker[key] = false;
            }
        }
        expand_tracker[''] = true;
    }
    expandRow(row_id, expand_tracker, expand_event, suppress_event, configs, display_data, store) {
        if (configs.subgrid) {
            this.expandSubgridRow(row_id, expand_tracker, expand_event, suppress_event, configs, display_data, store);
            return;
        }
        const row_index = this.findRowIndex(display_data, configs, row_id);
        const row_data = display_data[row_index];
        const pathx = row_data.pathx;
        const parts = pathx.split('.');
        expand_tracker[row_data.pathx] = true;
        let expanded_count = 1;
        for (let index = 0; index < display_data.length; index++) {
            const record = display_data[index];
            // Stop when all rows are expanded.
            if (expanded_count >= parts.length) {
                return;
            }
            // Join paths as we expand.
            const key = parts.slice(0, expanded_count).join('.');
            // We don't want to expand it's children here.
            if (record.pathx.indexOf(key) !== -1) {
                expanded_count += 1;
                expand_tracker[record.pathx] = true;
                if (!suppress_event) {
                    if (configs.load_children_on_expand) {
                        this.emitExpandRowEvent(expand_tracker, expand_event, store, row_data, configs);
                    }
                    else {
                        expand_event.emit({ event: null, data: row_data });
                    }
                }
            }
        }
    }
    collapseRow(row_id, expand_tracker, collapse_event, suppress_event, configs, display_data) {
        const row_index = this.findRowIndex(display_data, configs, row_id);
        const row_data = display_data[row_index];
        const pathx = row_data.pathx;
        expand_tracker[pathx] = false;
        // Collapse children rows as well
        display_data.forEach(record => {
            if (record.pathx.indexOf(pathx) !== -1) {
                expand_tracker[record.pathx] = 0;
                if (!suppress_event) {
                    collapse_event.emit({ event: null, data: row_data });
                }
            }
        });
    }
    emitExpandRowEvent(expand_tracker, expand, store, row_data, configs) {
        const promise = new Promise((resolve, reject) => {
            expand.emit({
                data: row_data,
                resolve: resolve
            });
        });
        expand_tracker[row_data.pathx] = true;
        store.remove_children(row_data);
        row_data.is_loading = true;
        // Add Child rows to the table.
        promise.then((child_rows) => {
            row_data.is_loading = false;
            store.remove_children(row_data);
            if (child_rows) {
                child_rows.map(child => {
                    child.leaf = true;
                    child.levelx = row_data.levelx + 1;
                    child.pathx = row_data.pathx + '.' + child[configs.id_field];
                    child.parent_pathx = row_data.pathx;
                    child[configs.parent_id_field] = row_data[configs.id_field];
                });
                store.add_children(row_data, child_rows);
            }
        }).catch((err) => { });
    }
    disableRowSelection(display_data, configs, row_id) {
        const row_index = this.findRowIndex(display_data, configs, row_id);
        display_data[row_index].selection_disabled = true;
    }
    enableRowSelection(display_data, configs, row_id) {
        const row_index = this.findRowIndex(display_data, configs, row_id);
        display_data[row_index].selection_disabled = false;
    }
    disableRowExpand(display_data, configs, row_id) {
        const row_index = this.findRowIndex(display_data, configs, row_id);
        display_data[row_index].expand_disabled = true;
    }
    enableRowExpand(display_data, configs, row_id) {
        const row_index = this.findRowIndex(display_data, configs, row_id);
        display_data[row_index].expand_disabled = false;
    }
    expandSubgridRow(row_id, expand_tracker, expand_event, suppress_event, configs, display_data, store) {
        const row_index = this.findRowIndex(display_data, configs, row_id);
        const row_data = display_data[row_index];
        expand_tracker[row_data.pathx] = true;
        if (!suppress_event) {
            this.emitSubgridExpandRowEvent(expand_tracker, expand_event, store, row_data);
        }
    }
    emitSubgridExpandRowEvent(expand_tracker, expand, store, row_data) {
        const promise = new Promise((resolve, reject) => {
            expand.emit({
                data: row_data,
                resolve: resolve
            });
        });
        expand_tracker[row_data.pathx] = true;
        const blank_row = store.showBlankRow(row_data);
        blank_row.loading_children = true;
        // Add Child rows to the table.
        promise.then((child_rows) => {
            blank_row.loading_children = false;
            if (child_rows) {
                child_rows.map(child => {
                    child.leaf = true;
                });
                blank_row.children = child_rows;
            }
            else {
                // Persist old children. If didn't exist then assign blank array.
                if (!blank_row.children) {
                    blank_row.children = [];
                }
            }
        }).catch((err) => { });
    }
}
AngularTreeGridService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: AngularTreeGridService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
AngularTreeGridService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: AngularTreeGridService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: AngularTreeGridService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci10cmVlLWdyaWQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItdHJlZS1ncmlkL3NyYy9saWIvYW5ndWxhci10cmVlLWdyaWQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7O0FBSy9CLE1BQU0sT0FBTyxzQkFBc0I7SUFLakM7UUFIUSw0QkFBdUIsR0FBRyxJQUFJLE9BQU8sRUFBUyxDQUFDO1FBQ3ZELDZCQUF3QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUV2RCxDQUFDO0lBRWpCLDJCQUEyQixDQUFDLFlBQW1CO1FBQzdDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELFlBQVksQ0FBQyxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU07UUFDeEMsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELFNBQVMsQ0FBQyxZQUFZO1FBQ3BCLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsV0FBVyxDQUFDLFlBQVk7UUFDdEIsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztJQUNM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QUFJLENBQUM7Z0JBQ1YsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsT0FBTyxFQUFFLE9BQU87YUFDakIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxjQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQztRQUN0QyxNQUFNLFNBQVMsR0FBUSxLQUFLLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3BELFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFFbEMsK0JBQStCO1FBQy9CLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxVQUFlLEVBQUUsRUFBRTtZQUMvQixTQUFTLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1lBRW5DLElBQUksVUFBVSxFQUFFO2dCQUNkLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7b0JBQ3JCLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO2dCQUNwQixDQUFDLENBQUMsQ0FBQztnQkFDSCxTQUFTLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQzthQUNqQztpQkFBTTtnQkFFTCxpRUFBaUU7Z0JBQ2pFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFO29CQUN2QixTQUFTLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztpQkFDekI7YUFDRjtRQUVILENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLEdBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEIsQ0FBQzs7bUhBbE1VLHNCQUFzQjt1SEFBdEIsc0JBQXNCLGNBRnJCLE1BQU07MkZBRVAsc0JBQXNCO2tCQUhsQyxVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhclRyZWVHcmlkU2VydmljZSB7XG5cbiAgcHJpdmF0ZSBkaXNwbGF5X2RhdGFfb2JzZXJ2YWJsZSA9IG5ldyBTdWJqZWN0PGFueVtdPigpO1xuICBkaXNwbGF5X2RhdGFfb2JzZXJ2YWJsZSQgPSB0aGlzLmRpc3BsYXlfZGF0YV9vYnNlcnZhYmxlLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGNvbnN0cnVjdG9yKCkgeyB9XG5cbiAgdXBkYXRlRGlzcGxheURhdGFPYnNlcnZhYmxlKGRpc3BsYXlfZGF0YTogYW55W10pIHtcbiAgICB0aGlzLmRpc3BsYXlfZGF0YV9vYnNlcnZhYmxlLm5leHQoZGlzcGxheV9kYXRhKTtcbiAgfVxuXG4gIGZpbmRSb3dJbmRleChkaXNwbGF5X2RhdGEsIGNvbmZpZ3MsIHJvd19pZCkge1xuICAgIHJldHVybiBkaXNwbGF5X2RhdGEubWFwKHJvdyA9PiByb3dbY29uZmlncy5pZF9maWVsZF0pLlxuICAgICAgICAgICAgICAgICAgICBpbmRleE9mKHJvd19pZCk7XG4gIH1cblxuICBzZWxlY3RBbGwoZGlzcGxheV9kYXRhKSB7XG4gICAgZGlzcGxheV9kYXRhLmZvckVhY2goZGF0YSA9PiB7XG4gICAgICAgIGRhdGEucm93X3NlbGVjdGVkID0gdHJ1ZTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlU2VsZWN0QWxsKGRpc3BsYXlfZGF0YSkge1xuICAgIGRpc3BsYXlfZGF0YS5mb3JFYWNoKGRhdGEgPT4ge1xuICAgICAgICBkYXRhLnJvd19zZWxlY3RlZCA9IGZhbHNlO1xuICAgIH0pO1xuICB9XG5cbiAgZXhwYW5kQWxsKGV4cGFuZF90cmFja2VyKSB7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZXhwYW5kX3RyYWNrZXIpIHtcbiAgICAgIGlmIChleHBhbmRfdHJhY2tlci5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGV4cGFuZF90cmFja2VyW2tleV0gPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbGxhcHNlQWxsKGV4cGFuZF90cmFja2VyKSB7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gZXhwYW5kX3RyYWNrZXIpIHtcbiAgICAgIGlmIChleHBhbmRfdHJhY2tlci5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGV4cGFuZF90cmFja2VyW2tleV0gPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgZXhwYW5kX3RyYWNrZXJbJyddID0gdHJ1ZTtcbiAgfVxuXG4gIGV4cGFuZFJvdyhyb3dfaWQsIGV4cGFuZF90cmFja2VyLCBleHBhbmRfZXZlbnQsIHN1cHByZXNzX2V2ZW50LCBjb25maWdzLCBkaXNwbGF5X2RhdGEsIHN0b3JlKSB7XG4gICAgaWYgKGNvbmZpZ3Muc3ViZ3JpZCkge1xuICAgICAgdGhpcy5leHBhbmRTdWJncmlkUm93KHJvd19pZCwgZXhwYW5kX3RyYWNrZXIsIGV4cGFuZF9ldmVudCwgc3VwcHJlc3NfZXZlbnQsIGNvbmZpZ3MsIGRpc3BsYXlfZGF0YSwgc3RvcmUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCByb3dfaW5kZXggPSB0aGlzLmZpbmRSb3dJbmRleChkaXNwbGF5X2RhdGEsIGNvbmZpZ3MsIHJvd19pZCk7XG5cbiAgICBjb25zdCByb3dfZGF0YSA9IGRpc3BsYXlfZGF0YVtyb3dfaW5kZXhdO1xuICAgIGNvbnN0IHBhdGh4ID0gcm93X2RhdGEucGF0aHg7XG4gICAgY29uc3QgcGFydHMgPSBwYXRoeC5zcGxpdCgnLicpO1xuICAgIGV4cGFuZF90cmFja2VyW3Jvd19kYXRhLnBhdGh4XSA9IHRydWU7XG4gICAgbGV0IGV4cGFuZGVkX2NvdW50ID0gMTtcblxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBkaXNwbGF5X2RhdGEubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCByZWNvcmQgPSBkaXNwbGF5X2RhdGFbaW5kZXhdO1xuXG4gICAgICAvLyBTdG9wIHdoZW4gYWxsIHJvd3MgYXJlIGV4cGFuZGVkLlxuICAgICAgaWYgKGV4cGFuZGVkX2NvdW50ID49IHBhcnRzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIC8vIEpvaW4gcGF0aHMgYXMgd2UgZXhwYW5kLlxuICAgICAgY29uc3Qga2V5ID0gcGFydHMuc2xpY2UoMCwgZXhwYW5kZWRfY291bnQpLmpvaW4oJy4nKTtcblxuICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBleHBhbmQgaXQncyBjaGlsZHJlbiBoZXJlLlxuICAgICAgaWYgKHJlY29yZC5wYXRoeC5pbmRleE9mKGtleSkgIT09IC0xKSB7XG4gICAgICAgICAgZXhwYW5kZWRfY291bnQgKz0gMTtcbiAgICAgICAgICBleHBhbmRfdHJhY2tlcltyZWNvcmQucGF0aHhdID0gdHJ1ZTtcblxuICAgICAgICAgIGlmICghc3VwcHJlc3NfZXZlbnQpIHtcbiAgICAgICAgICAgICAgaWYgKGNvbmZpZ3MubG9hZF9jaGlsZHJlbl9vbl9leHBhbmQpIHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdEV4cGFuZFJvd0V2ZW50KGV4cGFuZF90cmFja2VyLCBleHBhbmRfZXZlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgc3RvcmUsIHJvd19kYXRhLCBjb25maWdzKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIGV4cGFuZF9ldmVudC5lbWl0KHtldmVudDogbnVsbCwgZGF0YTogcm93X2RhdGF9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb2xsYXBzZVJvdyhyb3dfaWQsIGV4cGFuZF90cmFja2VyLCBjb2xsYXBzZV9ldmVudCwgc3VwcHJlc3NfZXZlbnQsIGNvbmZpZ3MsIGRpc3BsYXlfZGF0YSkge1xuICAgICAgY29uc3Qgcm93X2luZGV4ID0gdGhpcy5maW5kUm93SW5kZXgoZGlzcGxheV9kYXRhLCBjb25maWdzLCByb3dfaWQpO1xuXG4gICAgICBjb25zdCByb3dfZGF0YSA9IGRpc3BsYXlfZGF0YVtyb3dfaW5kZXhdO1xuICAgICAgY29uc3QgcGF0aHggPSByb3dfZGF0YS5wYXRoeDtcbiAgICAgIGV4cGFuZF90cmFja2VyW3BhdGh4XSA9IGZhbHNlO1xuXG4gICAgICAvLyBDb2xsYXBzZSBjaGlsZHJlbiByb3dzIGFzIHdlbGxcbiAgICAgIGRpc3BsYXlfZGF0YS5mb3JFYWNoKHJlY29yZCA9PiB7XG4gICAgICAgICAgaWYgKHJlY29yZC5wYXRoeC5pbmRleE9mKHBhdGh4KSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgZXhwYW5kX3RyYWNrZXJbcmVjb3JkLnBhdGh4XSA9IDA7XG4gICAgICAgICAgICAgIGlmICghc3VwcHJlc3NfZXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgIGNvbGxhcHNlX2V2ZW50LmVtaXQoe2V2ZW50OiBudWxsLCBkYXRhOiByb3dfZGF0YX0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBlbWl0RXhwYW5kUm93RXZlbnQoZXhwYW5kX3RyYWNrZXIsIGV4cGFuZCwgc3RvcmUsIHJvd19kYXRhLCBjb25maWdzKSB7XG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGV4cGFuZC5lbWl0KHtcbiAgICAgICAgZGF0YTogcm93X2RhdGEsXG4gICAgICAgIHJlc29sdmU6IHJlc29sdmVcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZXhwYW5kX3RyYWNrZXJbcm93X2RhdGEucGF0aHhdID0gdHJ1ZTtcbiAgICBzdG9yZS5yZW1vdmVfY2hpbGRyZW4ocm93X2RhdGEpO1xuICAgIHJvd19kYXRhLmlzX2xvYWRpbmcgPSB0cnVlO1xuXG4gICAgLy8gQWRkIENoaWxkIHJvd3MgdG8gdGhlIHRhYmxlLlxuICAgIHByb21pc2UudGhlbigoY2hpbGRfcm93czogYW55KSA9PiB7XG4gICAgICByb3dfZGF0YS5pc19sb2FkaW5nID0gZmFsc2U7XG4gICAgICBzdG9yZS5yZW1vdmVfY2hpbGRyZW4ocm93X2RhdGEpO1xuICAgICAgaWYgKGNoaWxkX3Jvd3MpIHtcbiAgICAgICAgY2hpbGRfcm93cy5tYXAoY2hpbGQgPT4ge1xuICAgICAgICAgIGNoaWxkLmxlYWYgPSB0cnVlO1xuICAgICAgICAgIGNoaWxkLmxldmVseCA9IHJvd19kYXRhLmxldmVseCArIDE7XG4gICAgICAgICAgY2hpbGQucGF0aHggPSByb3dfZGF0YS5wYXRoeCArICcuJyArIGNoaWxkW2NvbmZpZ3MuaWRfZmllbGRdO1xuICAgICAgICAgIGNoaWxkLnBhcmVudF9wYXRoeCA9IHJvd19kYXRhLnBhdGh4O1xuICAgICAgICAgIGNoaWxkW2NvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSA9IHJvd19kYXRhW2NvbmZpZ3MuaWRfZmllbGRdO1xuICAgICAgICB9KTtcblxuICAgICAgICBzdG9yZS5hZGRfY2hpbGRyZW4ocm93X2RhdGEsIGNoaWxkX3Jvd3MpO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHt9KTtcbiAgfVxuXG4gIGRpc2FibGVSb3dTZWxlY3Rpb24oZGlzcGxheV9kYXRhLCBjb25maWdzLCByb3dfaWQpIHtcbiAgICBjb25zdCByb3dfaW5kZXggPSB0aGlzLmZpbmRSb3dJbmRleChkaXNwbGF5X2RhdGEsIGNvbmZpZ3MsIHJvd19pZCk7XG4gICAgZGlzcGxheV9kYXRhW3Jvd19pbmRleF0uc2VsZWN0aW9uX2Rpc2FibGVkID0gdHJ1ZTtcbiAgfVxuXG4gIGVuYWJsZVJvd1NlbGVjdGlvbihkaXNwbGF5X2RhdGEsIGNvbmZpZ3MsIHJvd19pZCkge1xuICAgIGNvbnN0IHJvd19pbmRleCA9IHRoaXMuZmluZFJvd0luZGV4KGRpc3BsYXlfZGF0YSwgY29uZmlncywgcm93X2lkKTtcbiAgICBkaXNwbGF5X2RhdGFbcm93X2luZGV4XS5zZWxlY3Rpb25fZGlzYWJsZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGRpc2FibGVSb3dFeHBhbmQoZGlzcGxheV9kYXRhLCBjb25maWdzLCByb3dfaWQpIHtcbiAgICBjb25zdCByb3dfaW5kZXggPSB0aGlzLmZpbmRSb3dJbmRleChkaXNwbGF5X2RhdGEsIGNvbmZpZ3MsIHJvd19pZCk7XG4gICAgZGlzcGxheV9kYXRhW3Jvd19pbmRleF0uZXhwYW5kX2Rpc2FibGVkID0gdHJ1ZTtcbiAgfVxuXG4gIGVuYWJsZVJvd0V4cGFuZChkaXNwbGF5X2RhdGEsIGNvbmZpZ3MsIHJvd19pZCkge1xuICAgIGNvbnN0IHJvd19pbmRleCA9IHRoaXMuZmluZFJvd0luZGV4KGRpc3BsYXlfZGF0YSwgY29uZmlncywgcm93X2lkKTtcbiAgICBkaXNwbGF5X2RhdGFbcm93X2luZGV4XS5leHBhbmRfZGlzYWJsZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGV4cGFuZFN1YmdyaWRSb3cocm93X2lkLCBleHBhbmRfdHJhY2tlciwgZXhwYW5kX2V2ZW50LCBzdXBwcmVzc19ldmVudCwgY29uZmlncywgZGlzcGxheV9kYXRhLCBzdG9yZSkge1xuICAgIGNvbnN0IHJvd19pbmRleCA9IHRoaXMuZmluZFJvd0luZGV4KGRpc3BsYXlfZGF0YSwgY29uZmlncywgcm93X2lkKTtcbiAgICBjb25zdCByb3dfZGF0YSA9IGRpc3BsYXlfZGF0YVtyb3dfaW5kZXhdO1xuICAgIGV4cGFuZF90cmFja2VyW3Jvd19kYXRhLnBhdGh4XSA9IHRydWU7XG5cbiAgICBpZiAoIXN1cHByZXNzX2V2ZW50KSB7XG4gICAgICB0aGlzLmVtaXRTdWJncmlkRXhwYW5kUm93RXZlbnQoZXhwYW5kX3RyYWNrZXIsIGV4cGFuZF9ldmVudCwgc3RvcmUsIHJvd19kYXRhKTtcbiAgICB9XG4gIH1cblxuICBlbWl0U3ViZ3JpZEV4cGFuZFJvd0V2ZW50KGV4cGFuZF90cmFja2VyLCBleHBhbmQsIHN0b3JlLCByb3dfZGF0YSkge1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBleHBhbmQuZW1pdCh7XG4gICAgICAgIGRhdGE6IHJvd19kYXRhLFxuICAgICAgICByZXNvbHZlOiByZXNvbHZlXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGV4cGFuZF90cmFja2VyW3Jvd19kYXRhLnBhdGh4XSA9IHRydWU7XG4gICAgY29uc3QgYmxhbmtfcm93OiBhbnkgPSBzdG9yZS5zaG93QmxhbmtSb3cocm93X2RhdGEpO1xuICAgIGJsYW5rX3Jvdy5sb2FkaW5nX2NoaWxkcmVuID0gdHJ1ZTtcblxuICAgIC8vIEFkZCBDaGlsZCByb3dzIHRvIHRoZSB0YWJsZS5cbiAgICBwcm9taXNlLnRoZW4oKGNoaWxkX3Jvd3M6IGFueSkgPT4ge1xuICAgICAgYmxhbmtfcm93LmxvYWRpbmdfY2hpbGRyZW4gPSBmYWxzZTtcblxuICAgICAgaWYgKGNoaWxkX3Jvd3MpIHtcbiAgICAgICAgY2hpbGRfcm93cy5tYXAoY2hpbGQgPT4ge1xuICAgICAgICAgIGNoaWxkLmxlYWYgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgYmxhbmtfcm93LmNoaWxkcmVuID0gY2hpbGRfcm93cztcbiAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgLy8gUGVyc2lzdCBvbGQgY2hpbGRyZW4uIElmIGRpZG4ndCBleGlzdCB0aGVuIGFzc2lnbiBibGFuayBhcnJheS5cbiAgICAgICAgaWYgKCFibGFua19yb3cuY2hpbGRyZW4pIHtcbiAgICAgICAgICBibGFua19yb3cuY2hpbGRyZW4gPSBbXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge30pO1xuICB9XG5cbn1cbiJdfQ==