export class Store {
    constructor(angularTreeGridService) {
        this.angularTreeGridService = angularTreeGridService;
    }
    getRawData() {
        return this.raw_data;
    }
    setRawData(raw_data) {
        this.raw_data = raw_data;
    }
    getProcessedData() {
        return this.processed_data;
    }
    setProcessedData(processed_data) {
        this.processed_data = processed_data;
        this.setDisplayData([...processed_data]);
    }
    getDisplayData() {
        return this.display_data;
    }
    setDisplayData(display_data) {
        this.display_data = display_data;
        this.angularTreeGridService.updateDisplayDataObservable(this.display_data);
    }
    /**
     * Show Blank row for subgrid.
     *
     * @param  row_data Row Data
     * @returns blank_row
     */
    showBlankRow(row_data) {
        const row_index = this.display_data.map(row => row[this.configs.id_field]).
            indexOf(row_data[this.configs.id_field]);
        let blank_row = this.display_data[row_index + 1];
        if (!blank_row || blank_row.parent_pathx !== row_data[this.configs.id_field]) {
            blank_row = {
                leaf: true,
                row_selected: true,
                parent_pathx: row_data[this.configs.id_field]
            };
            blank_row[this.configs.id_field] = -1;
            this.display_data.splice(row_index + 1, 0, blank_row);
        }
        return blank_row;
    }
    remove_children(row_data) {
        const new_processed_data = [];
        for (let index = 0; index < this.processed_data.length; index++) {
            const element = this.processed_data[index];
            if (element[this.configs.parent_id_field] !== row_data[this.configs.id_field]) {
                new_processed_data.push(element);
            }
        }
        this.setProcessedData(new_processed_data);
    }
    add_children(row_data, children) {
        const row_index = this.processed_data.map(row => row[this.configs.id_field]).
            indexOf(row_data[this.configs.id_field]);
        const top_rows = this.processed_data.slice(0, row_index + 1);
        const bottom_rows = this.processed_data.slice(row_index + 1);
        this.processed_data = top_rows.concat(children).concat(bottom_rows);
        this.setDisplayData([...this.processed_data]);
        this.angularTreeGridService.updateDisplayDataObservable(this.display_data);
    }
    filterBy(columns, search_values) {
        this.display_data = this.processed_data.filter((record) => {
            let found = true;
            for (let index = 0; index < columns.length; index++) {
                const column = columns[index];
                let column_value = record[column.name];
                let search_value = search_values[index];
                // If blank then continue.
                if (!search_value) {
                    continue;
                }
                // Call custom filter function.
                if (column.filter_function) {
                    const response = column.filter_function(record, column, column_value, search_value);
                    if (response === false) {
                        found = false;
                    }
                }
                else {
                    if (typeof (column_value) === 'number') {
                        if (column_value !== parseInt(search_value, 10)) {
                            found = false;
                        }
                    }
                    else {
                        if (!column.case_sensitive_filter) {
                            column_value = column_value.toLowerCase();
                            search_value = search_value.toLowerCase();
                        }
                        if (column_value.indexOf(search_value) === -1) {
                            found = false;
                        }
                    }
                }
            }
            return found;
        });
        this.angularTreeGridService.updateDisplayDataObservable(this.display_data);
    }
    findTopParentNode(data, configs) {
        const ids = data.map(element => element[configs.id_field]);
        let top_parents = [];
        // Find parents ie if parent_id is not present in ids.
        data.forEach(element => {
            if (ids.indexOf(element[configs.parent_id_field]) === -1) {
                top_parents.push(element[configs.parent_id_field]);
            }
        });
        // Remove duplicates
        top_parents = top_parents.filter(function (item, pos, self) {
            return self.indexOf(item) === pos;
        });
        return top_parents;
    }
    processData(data, expand_tracker, configs, edit_tracker, internal_configs) {
        const top_parents = this.findTopParentNode(data, configs);
        const processed_data = [];
        internal_configs.top_parents = top_parents;
        data.map(rec => {
            rec.pathx = [];
            rec.leaf = false;
        });
        top_parents.forEach(top_parent => {
            const children = this.findChildren(data, top_parent, configs);
            this.orderData(data, processed_data, configs, children, [], 0);
        });
        processed_data.map(rec => {
            const parent_pathx = rec.parent_pathx;
            rec.parent_pathx = parent_pathx.join('.');
            parent_pathx.push(rec[configs.id_field]);
            // Add current id to create current path.
            rec.pathx = parent_pathx.join('.');
            edit_tracker[rec[configs.id_field]] = false;
            // For Subgrid feature, expect all rows are expandable.
            if (configs.subgrid) {
                rec.leaf = false;
            }
        });
        // Expand root.
        expand_tracker[''] = true;
        this.setProcessedData(processed_data);
        this.setRawData(data);
        this.configs = configs;
    }
    findChildren(data, id, configs) {
        return data.filter(rec => rec[configs.parent_id_field] === id);
    }
    orderData(data, processed_data, configs, parents, paths, levelx) {
        parents.forEach(parent => {
            const children = this.findChildren(data, parent[configs.id_field], configs);
            if (children.length === 0) {
                parent.leaf = true;
                parent.levelx = levelx;
                parent.parent_pathx = [...paths];
                processed_data.push(parent);
            }
            else {
                parent.parent_pathx = [...paths];
                parent.levelx = levelx;
                processed_data.push(parent);
                const newPaths = [...paths, parent[configs.id_field]];
                this.orderData(data, processed_data, configs, children, newPaths, levelx + 1);
            }
        });
    }
    refreshDisplayData() {
        this.display_data = this.processed_data;
        this.angularTreeGridService.updateDisplayDataObservable(this.display_data);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLXRyZWUtZ3JpZC9zcmMvbGliL3N0b3JlL3N0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE1BQU0sT0FBTyxLQUFLO0lBTWQsWUFBb0Isc0JBQThDO1FBQTlDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7SUFBSSxDQUFDO0lBRXZFLFVBQVU7UUFDTixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDekIsQ0FBQztJQUVELFVBQVUsQ0FBQyxRQUFRO1FBQ2YsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDN0IsQ0FBQztJQUVELGdCQUFnQjtRQUNaLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUMvQixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsY0FBYztRQUMzQixJQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztRQUNyQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxjQUFjO1FBQ1YsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzdCLENBQUM7SUFFRCxjQUFjLENBQUMsWUFBWTtRQUN2QixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsMkJBQTJCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILFlBQVksQ0FBQyxRQUFRO1FBQ2pCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEUsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxD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SSxDQUFDLGNBQWMsQ0FBQztRQUN4QyxJQUFJLENBQUMsc0JBQXNCLENBQUMsMkJBQTJCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQy9FLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFuZ3VsYXJUcmVlR3JpZFNlcnZpY2UgfSBmcm9tICcuLi9hbmd1bGFyLXRyZWUtZ3JpZC5zZXJ2aWNlJztcbmltcG9ydCB7IENvbmZpZ3MgfSBmcm9tICcuLi9tb2RlbHMvQ29uZmlncy5tb2RlbCc7XG5cbmV4cG9ydCBjbGFzcyBTdG9yZSB7XG4gICAgcHJvY2Vzc2VkX2RhdGE6IGFueVtdO1xuICAgIHJhd19kYXRhOiBhbnlbXTtcbiAgICBkaXNwbGF5X2RhdGE6IGFueVtdO1xuICAgIGNvbmZpZ3M6IENvbmZpZ3M7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFuZ3VsYXJUcmVlR3JpZFNlcnZpY2U6IEFuZ3VsYXJUcmVlR3JpZFNlcnZpY2UpIHsgfVxuXG4gICAgZ2V0UmF3RGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmF3X2RhdGE7XG4gICAgfVxuXG4gICAgc2V0UmF3RGF0YShyYXdfZGF0YSkge1xuICAgICAgICB0aGlzLnJhd19kYXRhID0gcmF3X2RhdGE7XG4gICAgfVxuXG4gICAgZ2V0UHJvY2Vzc2VkRGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc2VkX2RhdGE7XG4gICAgfVxuXG4gICAgc2V0UHJvY2Vzc2VkRGF0YShwcm9jZXNzZWRfZGF0YSkge1xuICAgICAgICB0aGlzLnByb2Nlc3NlZF9kYXRhID0gcHJvY2Vzc2VkX2RhdGE7XG4gICAgICAgIHRoaXMuc2V0RGlzcGxheURhdGEoWy4uLnByb2Nlc3NlZF9kYXRhXSk7XG4gICAgfVxuXG4gICAgZ2V0RGlzcGxheURhdGEoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRpc3BsYXlfZGF0YTtcbiAgICB9XG5cbiAgICBzZXREaXNwbGF5RGF0YShkaXNwbGF5X2RhdGEpIHtcbiAgICAgICAgdGhpcy5kaXNwbGF5X2RhdGEgPSBkaXNwbGF5X2RhdGE7XG4gICAgICAgIHRoaXMuYW5ndWxhclRyZWVHcmlkU2VydmljZS51cGRhdGVEaXNwbGF5RGF0YU9ic2VydmFibGUodGhpcy5kaXNwbGF5X2RhdGEpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNob3cgQmxhbmsgcm93IGZvciBzdWJncmlkLlxuICAgICAqXG4gICAgICogQHBhcmFtICByb3dfZGF0YSBSb3cgRGF0YVxuICAgICAqIEByZXR1cm5zIGJsYW5rX3Jvd1xuICAgICAqL1xuICAgIHNob3dCbGFua1Jvdyhyb3dfZGF0YSkge1xuICAgICAgICBjb25zdCByb3dfaW5kZXggPSB0aGlzLmRpc3BsYXlfZGF0YS5tYXAocm93ID0+IHJvd1t0aGlzLmNvbmZpZ3MuaWRfZmllbGRdKS5cbiAgICAgICAgICAgIGluZGV4T2Yocm93X2RhdGFbdGhpcy5jb25maWdzLmlkX2ZpZWxkXSk7XG5cbiAgICAgICAgbGV0IGJsYW5rX3JvdyA9IHRoaXMuZGlzcGxheV9kYXRhW3Jvd19pbmRleCArIDFdO1xuICAgICAgICBpZiAoIWJsYW5rX3JvdyB8fCBibGFua19yb3cucGFyZW50X3BhdGh4ICE9PSByb3dfZGF0YVt0aGlzLmNvbmZpZ3MuaWRfZmllbGRdKSB7XG4gICAgICAgICAgICBibGFua19yb3cgPSB7XG4gICAgICAgICAgICAgICAgbGVhZjogdHJ1ZSxcbiAgICAgICAgICAgICAgICByb3dfc2VsZWN0ZWQ6IHRydWUsIC8vIEJ5IGRlZmF1bHQgbWFrZSBpdCBzZWxlY3RlZCBhcyBpdCdzIG5ldmVyIGdvaW5nIHRvIGJlIHNlbGVjdGVkIG1hbnVhbGx5LlxuICAgICAgICAgICAgICAgIHBhcmVudF9wYXRoeDogcm93X2RhdGFbdGhpcy5jb25maWdzLmlkX2ZpZWxkXVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJsYW5rX3Jvd1t0aGlzLmNvbmZpZ3MuaWRfZmllbGRdID0gLTE7XG4gICAgICAgICAgICB0aGlzLmRpc3BsYXlfZGF0YS5zcGxpY2Uocm93X2luZGV4ICsgMSwgMCwgYmxhbmtfcm93KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBibGFua19yb3c7XG4gICAgfVxuXG4gICAgcmVtb3ZlX2NoaWxkcmVuKHJvd19kYXRhKSB7XG4gICAgICAgIGNvbnN0IG5ld19wcm9jZXNzZWRfZGF0YTogYW55ID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMucHJvY2Vzc2VkX2RhdGEubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5wcm9jZXNzZWRfZGF0YVtpbmRleF07XG4gICAgICAgICAgICBpZiAoZWxlbWVudFt0aGlzLmNvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSAhPT0gcm93X2RhdGFbdGhpcy5jb25maWdzLmlkX2ZpZWxkXSkge1xuICAgICAgICAgICAgICAgIG5ld19wcm9jZXNzZWRfZGF0YS5wdXNoKGVsZW1lbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRQcm9jZXNzZWREYXRhKG5ld19wcm9jZXNzZWRfZGF0YSk7XG4gICAgfVxuXG4gICAgYWRkX2NoaWxkcmVuKHJvd19kYXRhLCBjaGlsZHJlbikge1xuICAgICAgICBjb25zdCByb3dfaW5kZXggPSB0aGlzLnByb2Nlc3NlZF9kYXRhLm1hcChyb3cgPT4gcm93W3RoaXMuY29uZmlncy5pZF9maWVsZF0pLlxuICAgICAgICAgICAgaW5kZXhPZihyb3dfZGF0YVt0aGlzLmNvbmZpZ3MuaWRfZmllbGRdKTtcbiAgICAgICAgY29uc3QgdG9wX3Jvd3MgPSB0aGlzLnByb2Nlc3NlZF9kYXRhLnNsaWNlKDAsIHJvd19pbmRleCArIDEpO1xuICAgICAgICBjb25zdCBib3R0b21fcm93cyA9IHRoaXMucHJvY2Vzc2VkX2RhdGEuc2xpY2Uocm93X2luZGV4ICsgMSk7XG4gICAgICAgIHRoaXMucHJvY2Vzc2VkX2RhdGEgPSB0b3Bfcm93cy5jb25jYXQoY2hpbGRyZW4pLmNvbmNhdChib3R0b21fcm93cyk7XG5cbiAgICAgICAgdGhpcy5zZXREaXNwbGF5RGF0YShbLi4udGhpcy5wcm9jZXNzZWRfZGF0YV0pO1xuICAgICAgICB0aGlzLmFuZ3VsYXJUcmVlR3JpZFNlcnZpY2UudXBkYXRlRGlzcGxheURhdGFPYnNlcnZhYmxlKHRoaXMuZGlzcGxheV9kYXRhKTtcbiAgICB9XG5cbiAgICBmaWx0ZXJCeShjb2x1bW5zLCBzZWFyY2hfdmFsdWVzKSB7XG4gICAgICAgIHRoaXMuZGlzcGxheV9kYXRhID0gdGhpcy5wcm9jZXNzZWRfZGF0YS5maWx0ZXIoKHJlY29yZCkgPT4ge1xuICAgICAgICAgICAgbGV0IGZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBjb2x1bW5zLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbHVtbiA9IGNvbHVtbnNbaW5kZXhdO1xuICAgICAgICAgICAgICAgIGxldCBjb2x1bW5fdmFsdWUgPSByZWNvcmRbY29sdW1uLm5hbWVdO1xuICAgICAgICAgICAgICAgIGxldCBzZWFyY2hfdmFsdWUgPSBzZWFyY2hfdmFsdWVzW2luZGV4XTtcblxuICAgICAgICAgICAgICAgIC8vIElmIGJsYW5rIHRoZW4gY29udGludWUuXG4gICAgICAgICAgICAgICAgaWYgKCFzZWFyY2hfdmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gQ2FsbCBjdXN0b20gZmlsdGVyIGZ1bmN0aW9uLlxuICAgICAgICAgICAgICAgIGlmIChjb2x1bW4uZmlsdGVyX2Z1bmN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gY29sdW1uLmZpbHRlcl9mdW5jdGlvbihyZWNvcmQsIGNvbHVtbiwgY29sdW1uX3ZhbHVlLCBzZWFyY2hfdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAoY29sdW1uX3ZhbHVlKSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2x1bW5fdmFsdWUgIT09IHBhcnNlSW50KHNlYXJjaF92YWx1ZSwgMTApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29sdW1uLmNhc2Vfc2Vuc2l0aXZlX2ZpbHRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbl92YWx1ZSA9IGNvbHVtbl92YWx1ZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaF92YWx1ZSA9IHNlYXJjaF92YWx1ZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbl92YWx1ZS5pbmRleE9mKHNlYXJjaF92YWx1ZSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmb3VuZDtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuYW5ndWxhclRyZWVHcmlkU2VydmljZS51cGRhdGVEaXNwbGF5RGF0YU9ic2VydmFibGUodGhpcy5kaXNwbGF5X2RhdGEpO1xuICAgIH1cblxuICAgIGZpbmRUb3BQYXJlbnROb2RlKGRhdGEsIGNvbmZpZ3MpIHtcbiAgICAgICAgY29uc3QgaWRzID0gZGF0YS5tYXAoZWxlbWVudCA9PiBlbGVtZW50W2NvbmZpZ3MuaWRfZmllbGRdKTtcbiAgICAgICAgbGV0IHRvcF9wYXJlbnRzID0gW107XG5cbiAgICAgICAgLy8gRmluZCBwYXJlbnRzIGllIGlmIHBhcmVudF9pZCBpcyBub3QgcHJlc2VudCBpbiBpZHMuXG4gICAgICAgIGRhdGEuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICAgIGlmIChpZHMuaW5kZXhPZihlbGVtZW50W2NvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdG9wX3BhcmVudHMucHVzaChlbGVtZW50W2NvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzXG4gICAgICAgIHRvcF9wYXJlbnRzID0gdG9wX3BhcmVudHMuZmlsdGVyKGZ1bmN0aW9uIChpdGVtLCBwb3MsIHNlbGYpIHtcbiAgICAgICAgICAgIHJldHVybiBzZWxmLmluZGV4T2YoaXRlbSkgPT09IHBvcztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRvcF9wYXJlbnRzO1xuICAgIH1cblxuICAgIHByb2Nlc3NEYXRhKGRhdGEsIGV4cGFuZF90cmFja2VyLCBjb25maWdzOiBDb25maWdzLCBlZGl0X3RyYWNrZXIsIGludGVybmFsX2NvbmZpZ3MpIHtcbiAgICAgICAgY29uc3QgdG9wX3BhcmVudHMgPSB0aGlzLmZpbmRUb3BQYXJlbnROb2RlKGRhdGEsIGNvbmZpZ3MpO1xuICAgICAgICBjb25zdCBwcm9jZXNzZWRfZGF0YSA9IFtdO1xuICAgICAgICBpbnRlcm5hbF9jb25maWdzLnRvcF9wYXJlbnRzID0gdG9wX3BhcmVudHM7XG5cbiAgICAgICAgZGF0YS5tYXAocmVjID0+IHtcbiAgICAgICAgICAgIHJlYy5wYXRoeCA9IFtdO1xuICAgICAgICAgICAgcmVjLmxlYWYgPSBmYWxzZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdG9wX3BhcmVudHMuZm9yRWFjaCh0b3BfcGFyZW50ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5maW5kQ2hpbGRyZW4oZGF0YSwgdG9wX3BhcmVudCwgY29uZmlncyk7XG5cbiAgICAgICAgICAgIHRoaXMub3JkZXJEYXRhKGRhdGEsIHByb2Nlc3NlZF9kYXRhLCBjb25maWdzLCBjaGlsZHJlbiwgW10sIDApO1xuICAgICAgICB9KTtcblxuICAgICAgICBwcm9jZXNzZWRfZGF0YS5tYXAocmVjID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudF9wYXRoeCA9IHJlYy5wYXJlbnRfcGF0aHg7XG4gICAgICAgICAgICByZWMucGFyZW50X3BhdGh4ID0gcGFyZW50X3BhdGh4LmpvaW4oJy4nKTtcbiAgICAgICAgICAgIHBhcmVudF9wYXRoeC5wdXNoKHJlY1tjb25maWdzLmlkX2ZpZWxkXSk7XG5cbiAgICAgICAgICAgIC8vIEFkZCBjdXJyZW50IGlkIHRvIGNyZWF0ZSBjdXJyZW50IHBhdGguXG4gICAgICAgICAgICByZWMucGF0aHggPSBwYXJlbnRfcGF0aHguam9pbignLicpO1xuICAgICAgICAgICAgZWRpdF90cmFja2VyW3JlY1tjb25maWdzLmlkX2ZpZWxkXV0gPSBmYWxzZTtcblxuICAgICAgICAgICAgLy8gRm9yIFN1YmdyaWQgZmVhdHVyZSwgZXhwZWN0IGFsbCByb3dzIGFyZSBleHBhbmRhYmxlLlxuICAgICAgICAgICAgaWYgKGNvbmZpZ3Muc3ViZ3JpZCkge1xuICAgICAgICAgICAgICAgIHJlYy5sZWFmID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEV4cGFuZCByb290LlxuICAgICAgICBleHBhbmRfdHJhY2tlclsnJ10gPSB0cnVlO1xuICAgICAgICB0aGlzLnNldFByb2Nlc3NlZERhdGEocHJvY2Vzc2VkX2RhdGEpO1xuICAgICAgICB0aGlzLnNldFJhd0RhdGEoZGF0YSk7XG4gICAgICAgIHRoaXMuY29uZmlncyA9IGNvbmZpZ3M7XG4gICAgfVxuXG4gICAgZmluZENoaWxkcmVuKGRhdGEsIGlkLCBjb25maWdzKSB7XG4gICAgICAgIHJldHVybiBkYXRhLmZpbHRlcihyZWMgPT4gcmVjW2NvbmZpZ3MucGFyZW50X2lkX2ZpZWxkXSA9PT0gaWQpO1xuICAgIH1cblxuICAgIG9yZGVyRGF0YShkYXRhLCBwcm9jZXNzZWRfZGF0YSwgY29uZmlncywgcGFyZW50cywgcGF0aHMsIGxldmVseCkge1xuICAgICAgICBwYXJlbnRzLmZvckVhY2gocGFyZW50ID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5maW5kQ2hpbGRyZW4oZGF0YSwgcGFyZW50W2NvbmZpZ3MuaWRfZmllbGRdLCBjb25maWdzKTtcblxuICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHBhcmVudC5sZWFmID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBwYXJlbnQubGV2ZWx4ID0gbGV2ZWx4O1xuICAgICAgICAgICAgICAgIHBhcmVudC5wYXJlbnRfcGF0aHggPSBbLi4ucGF0aHNdO1xuICAgICAgICAgICAgICAgIHByb2Nlc3NlZF9kYXRhLnB1c2gocGFyZW50KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGFyZW50LnBhcmVudF9wYXRoeCA9IFsuLi5wYXRoc107XG4gICAgICAgICAgICAgICAgcGFyZW50LmxldmVseCA9IGxldmVseDtcbiAgICAgICAgICAgICAgICBwcm9jZXNzZWRfZGF0YS5wdXNoKHBhcmVudCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBuZXdQYXRocyA9IFsuLi5wYXRocywgcGFyZW50W2NvbmZpZ3MuaWRfZmllbGRdXTtcbiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGF0YShkYXRhLCBwcm9jZXNzZWRfZGF0YSwgY29uZmlncywgY2hpbGRyZW4sIG5ld1BhdGhzLCBsZXZlbHggKyAxKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZWZyZXNoRGlzcGxheURhdGEoKSB7XG4gICAgICAgIHRoaXMuZGlzcGxheV9kYXRhID0gdGhpcy5wcm9jZXNzZWRfZGF0YTtcbiAgICAgICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLnVwZGF0ZURpc3BsYXlEYXRhT2JzZXJ2YWJsZSh0aGlzLmRpc3BsYXlfZGF0YSk7XG4gICAgfVxufVxuIl19