import { Component, Input, Output, EventEmitter } from '@angular/core';
import { Store } from './store/store';
import * as i0 from "@angular/core";
import * as i1 from "./angular-tree-grid.service";
import * as i2 from "./modules/tree-head/tree-head.component";
import * as i3 from "./modules/tree-body/tree-body.component";
export class AngularTreeGridComponent {
    constructor(angularTreeGridService) {
        this.angularTreeGridService = angularTreeGridService;
        this.processed_data = [];
        this.expand_tracker = {};
        this.columns = [];
        this.edit_tracker = {}; // Track Edit options.
        this.internal_configs = {
            show_add_row: false,
            show_parent_col: false,
            all_selected: false
        };
        this.store = new Store(this.angularTreeGridService);
        this.default_configs = {
            css: {
                expand_icon: '',
                collapse_icon: '',
                add_icon: '',
                edit_icon: '',
                delete_icon: '',
                save_icon: '',
                cancel_icon: '',
                row_selection_class: 'selected',
                header_class: '',
                row_filter_class: '',
                table_class: ''
            },
            actions: {
                edit: false,
                add: false,
                delete: false,
                resolve_edit: false,
                resolve_add: false,
                resolve_delete: false,
                edit_parent: false
            },
            data_loading_text: 'Loading...',
            filter: false,
            multi_select: false,
            show_parent_on_edit: true,
            show_summary_row: false,
            subgrid: false,
            load_children_on_expand: false,
            action_column_width: '60px',
            row_class_function: () => '',
            row_edit_function: () => true,
            row_delete_function: () => true,
            subgrid_config: {
                show_summary_row: false,
                data_loading_text: 'Loading...'
            }
        };
        this.default_column_config = {
            sorted: 0,
            sort_type: null,
            editable: false,
            hidden: false,
            filter: true,
            case_sensitive_filter: false
        };
        this.cellclick = new EventEmitter();
        this.expand = new EventEmitter();
        this.collapse = new EventEmitter();
        this.rowselect = new EventEmitter();
        this.rowdeselect = new EventEmitter();
        this.rowselectall = new EventEmitter();
        this.rowdeselectall = new EventEmitter();
        this.rowadd = new EventEmitter();
        this.rowsave = new EventEmitter();
        this.rowdelete = new EventEmitter();
    }
    ngOnInit() {
        if (!this.validateConfigs()) {
            return;
        }
        this.setDefaultConfigs();
        this.setColumnNames();
    }
    ngOnChanges() {
        if (!this.validateConfigs()) {
            return;
        }
        this.setDefaultConfigs();
        this.setColumnNames();
        this.store.processData(this.data, this.expand_tracker, this.configs, this.edit_tracker, this.internal_configs);
    }
    validateConfigs() {
        if (!this.data) {
            window.console.warn('data can\'t be empty!');
            return;
        }
        if (!this.configs) {
            window.console.warn('configs can\'t be empty!');
            return;
        }
        const element = this.data[0];
        let isValidated = true;
        if (!this.configs.id_field) {
            isValidated = false;
            window.console.error('id field is mandatory!');
        }
        if (!this.configs.parent_id_field && !this.configs.subgrid) {
            isValidated = false;
            window.console.error('parent_id field is mandatory!');
        }
        if (element && !element.hasOwnProperty(this.configs.id_field)) {
            isValidated = false;
            console.error('id_field doesn\'t exist!');
        }
        if (element && !element.hasOwnProperty(this.configs.parent_id_field)
            && !this.configs.subgrid
            && !this.configs.load_children_on_expand) {
            isValidated = false;
            console.error('parent_id_field doesn\'t exist!');
        }
        if (element && !element.hasOwnProperty(this.configs.parent_display_field)) {
            isValidated = false;
            console.error('parent_display_field doesn\'t exist! Basically this field will be expanded.');
        }
        if (this.configs.subgrid && !this.configs.subgrid_config) {
            isValidated = false;
            console.error('subgrid_config doesn\'t exist!');
        }
        if (this.configs.subgrid && this.configs.subgrid_config && !this.configs.subgrid_config.id_field) {
            isValidated = false;
            console.error('id_field of subgrid doesn\'t exist!');
        }
        if (this.configs.subgrid && this.configs.subgrid_config && !this.configs.subgrid_config.columns) {
            isValidated = false;
            console.error('columns of subgrid doesn\'t exist!');
        }
        return isValidated;
    }
    setDefaultConfigs() {
        this.processed_data = [];
        this.configs = Object.assign({}, this.default_configs, this.configs);
        // Deep clone.
        this.configs.actions = Object.assign({}, this.default_configs.actions, this.configs.actions);
        this.configs.css = Object.assign({}, this.default_configs.css, this.configs.css);
        this.configs.subgrid_config = Object.assign({}, this.default_configs.subgrid_config, this.configs.subgrid_config);
        if (this.configs.subgrid) {
            this.configs.actions.add = false;
        }
    }
    setColumnNames() {
        this.columns = this.configs.columns ? this.configs.columns : [];
        // If columns doesn't exist in user's object.
        if (!this.configs.columns) {
            const column_keys = Object.keys(this.data[0]);
            // Insert Header and default configuration.
            column_keys.forEach(key => {
                this.columns.push(Object.assign({ 'header': key, 'name': key }, this.default_column_config));
            });
        }
        else {
            // Insert Header and default configuration.
            for (let i = 0; i < this.columns.length; i++) {
                this.columns[i] = Object.assign({}, this.default_column_config, this.columns[i]);
            }
        }
    }
    collapseAll() {
        this.angularTreeGridService.collapseAll(this.expand_tracker);
    }
    expandAll() {
        this.angularTreeGridService.expandAll(this.expand_tracker);
    }
    selectAll() {
        this.angularTreeGridService.selectAll(this.store.getDisplayData());
        this.internal_configs.all_selected = true;
    }
    deSelectAll() {
        this.angularTreeGridService.deSelectAll(this.store.getDisplayData());
        this.internal_configs.all_selected = false;
    }
    expandRow(row_id, suppress_event) {
        this.angularTreeGridService.expandRow(row_id, this.expand_tracker, this.expand, suppress_event, this.configs, this.store.getDisplayData(), this.store);
    }
    collapseRow(row_id, suppress_event) {
        this.angularTreeGridService.collapseRow(row_id, this.expand_tracker, this.collapse, suppress_event, this.configs, this.store.getDisplayData());
    }
    disableRowSelection(row_id) {
        this.angularTreeGridService.disableRowSelection(this.store.getDisplayData(), this.configs, row_id);
    }
    enableRowSelection(row_id) {
        this.angularTreeGridService.enableRowSelection(this.store.getDisplayData(), this.configs, row_id);
    }
    disableRowExpand(row_id) {
        this.angularTreeGridService.disableRowExpand(this.store.getDisplayData(), this.configs, row_id);
    }
    enableRowExpand(row_id) {
        this.angularTreeGridService.enableRowExpand(this.store.getDisplayData(), this.configs, row_id);
    }
}
AngularTreeGridComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: AngularTreeGridComponent, deps: [{ token: i1.AngularTreeGridService }], target: i0.ɵɵFactoryTarget.Component });
AngularTreeGridComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.2.1", type: AngularTreeGridComponent, selector: "db-angular-tree-grid", inputs: { data: "data", configs: "configs" }, outputs: { cellclick: "cellclick", expand: "expand", collapse: "collapse", rowselect: "rowselect", rowdeselect: "rowdeselect", rowselectall: "rowselectall", rowdeselectall: "rowdeselectall", rowadd: "rowadd", rowsave: "rowsave", rowdelete: "rowdelete" }, usesOnChanges: true, ngImport: i0, template: "<table [attr.class]=\"'db-tree-view ' + configs.css.table_class\" >\n    <thead \n        db-tree-head\n        [store]=\"store\"\n        [expand_tracker]=\"expand_tracker\"\n        [internal_configs]=\"internal_configs\"\n        [edit_tracker]=\"edit_tracker\"\n        [rowselectall]=\"rowselectall\"\n        [rowdeselectall]=\"rowdeselectall\"\n        [columns]=\"columns\"\n        [configs]=\"configs\">\n    </thead>\n\n    <tbody \n        db-tree-body\n        [store]=\"store\"\n        [expand_tracker]=\"expand_tracker\"\n        [edit_tracker]=\"edit_tracker\"\n        [internal_configs]=\"internal_configs\"\n        [columns]=\"columns\"\n        [configs]=\"configs\"\n        [cellclick]=\"cellclick\"\n        [expand]=\"expand\"\n        [collapse]=\"collapse\"\n        [rowdelete]=\"rowdelete\"\n        [rowsave]=\"rowsave\"\n        [rowadd]=\"rowadd\"\n        [rowselect]=\"rowselect\"\n        [rowdeselect]=\"rowdeselect\"\n    >        \n    </tbody>\n</table>", styles: [".db-tree-view{line-height:1.5em;border-collapse:collapse;border-spacing:0;display:table;max-width:100%;overflow:auto;word-break:normal;word-break:keep-all;color:#4b4b4b}\n"], components: [{ type: i2.TreeHeadComponent, selector: "[db-tree-head]", inputs: ["store", "configs", "expand_tracker", "edit_tracker", "internal_configs", "columns", "rowselectall", "rowdeselectall"] }, { type: i3.TreeBodyComponent, selector: "[db-tree-body]", inputs: ["store", "configs", "expand_tracker", "edit_tracker", "internal_configs", "columns", "cellclick", "expand", "collapse", "rowdelete", "rowsave", "rowadd", "rowselect", "rowdeselect"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.1", ngImport: i0, type: AngularTreeGridComponent, decorators: [{
            type: Component,
            args: [{ selector: 'db-angular-tree-grid', template: "<table [attr.class]=\"'db-tree-view ' + configs.css.table_class\" >\n    <thead \n        db-tree-head\n        [store]=\"store\"\n        [expand_tracker]=\"expand_tracker\"\n        [internal_configs]=\"internal_configs\"\n        [edit_tracker]=\"edit_tracker\"\n        [rowselectall]=\"rowselectall\"\n        [rowdeselectall]=\"rowdeselectall\"\n        [columns]=\"columns\"\n        [configs]=\"configs\">\n    </thead>\n\n    <tbody \n        db-tree-body\n        [store]=\"store\"\n        [expand_tracker]=\"expand_tracker\"\n        [edit_tracker]=\"edit_tracker\"\n        [internal_configs]=\"internal_configs\"\n        [columns]=\"columns\"\n        [configs]=\"configs\"\n        [cellclick]=\"cellclick\"\n        [expand]=\"expand\"\n        [collapse]=\"collapse\"\n        [rowdelete]=\"rowdelete\"\n        [rowsave]=\"rowsave\"\n        [rowadd]=\"rowadd\"\n        [rowselect]=\"rowselect\"\n        [rowdeselect]=\"rowdeselect\"\n    >        \n    </tbody>\n</table>", styles: [".db-tree-view{line-height:1.5em;border-collapse:collapse;border-spacing:0;display:table;max-width:100%;overflow:auto;word-break:normal;word-break:keep-all;color:#4b4b4b}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.AngularTreeGridService }]; }, propDecorators: { data: [{
                type: Input
            }], configs: [{
                type: Input
            }], cellclick: [{
                type: Output
            }], expand: [{
                type: Output
            }], collapse: [{
                type: Output
            }], rowselect: [{
                type: Output
            }], rowdeselect: [{
                type: Output
            }], rowselectall: [{
                type: Output
            }], rowdeselectall: [{
                type: Output
            }], rowadd: [{
                type: Output
            }], rowsave: [{
                type: Output
            }], rowdelete: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci10cmVlLWdyaWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvYW5ndWxhci10cmVlLWdyaWQvc3JjL2xpYi9hbmd1bGFyLXRyZWUtZ3JpZC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLXRyZWUtZ3JpZC9zcmMvbGliL2FuZ3VsYXItdHJlZS1ncmlkLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQWEsS0FBSyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFJMUYsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQzs7Ozs7QUFPdEMsTUFBTSxPQUFPLHdCQUF3QjtJQTZFbkMsWUFBb0Isc0JBQThDO1FBQTlDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUE1RWxFLG1CQUFjLEdBQVUsRUFBRSxDQUFDO1FBQzNCLG1CQUFjLEdBQVEsRUFBRSxDQUFDO1FBQ3pCLFlBQU8sR0FBYSxFQUFFLENBQUM7UUFDdkIsaUJBQVksR0FBUSxFQUFFLENBQUMsQ0FBQyxzQkFBc0I7UUFDOUMscUJBQWdCLEdBQVE7WUFDdEIsWUFBWSxFQUFFLEtBQUs7WUFDbkIsZUFBZSxFQUFFLEtBQUs7WUFDdEIsWUFBWSxFQUFFLEtBQUs7U0FDcEIsQ0FBQztRQUNGLFVBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQVEvQyxvQkFBZSxHQUFZO1lBQ3pCLEdBQUcsRUFBRTtnQkFDSCxXQUFXLEVBQUUsRUFBRTtnQkFDZixhQUFhLEVBQUUsRUFBRTtnQkFDakIsUUFBUSxFQUFFLEVBQUU7Z0JBQ1osU0FBUyxFQUFFLEVBQUU7Z0JBQ2IsV0FBVyxFQUFFLEVBQUU7Z0JBQ2YsU0FBUyxFQUFFLEVBQUU7Z0JBQ2IsV0FBVyxFQUFF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QVM7c0JBQWxCLE1BQU07Z0JBQ0csTUFBTTtzQkFBZixNQUFNO2dCQUNHLFFBQVE7c0JBQWpCLE1BQU07Z0JBQ0csU0FBUztzQkFBbEIsTUFBTTtnQkFDRyxXQUFXO3NCQUFwQixNQUFNO2dCQUNHLFlBQVk7c0JBQXJCLE1BQU07Z0JBQ0csY0FBYztzQkFBdkIsTUFBTTtnQkFDRyxNQUFNO3NCQUFmLE1BQU07Z0JBQ0csT0FBTztzQkFBaEIsTUFBTTtnQkFDRyxTQUFTO3NCQUFsQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkNoYW5nZXMsIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb25maWdzIH0gZnJvbSAnLi9tb2RlbHMvQ29uZmlncy5tb2RlbCc7XG5pbXBvcnQgeyBBbmd1bGFyVHJlZUdyaWRTZXJ2aWNlIH0gZnJvbSAnLi9hbmd1bGFyLXRyZWUtZ3JpZC5zZXJ2aWNlJztcbmltcG9ydCB7IENvbHVtbiB9IGZyb20gJy4vbW9kZWxzL0NvbHVtbi5tb2RlbCc7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gJy4vc3RvcmUvc3RvcmUnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdkYi1hbmd1bGFyLXRyZWUtZ3JpZCcsXG4gIHRlbXBsYXRlVXJsOiAnYW5ndWxhci10cmVlLWdyaWQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9hbmd1bGFyLXRyZWUtZ3JpZC5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJUcmVlR3JpZENvbXBvbmVudCBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25Jbml0IHtcbiAgcHJvY2Vzc2VkX2RhdGE6IGFueVtdID0gW107XG4gIGV4cGFuZF90cmFja2VyOiBhbnkgPSB7fTtcbiAgY29sdW1uczogQ29sdW1uW10gPSBbXTtcbiAgZWRpdF90cmFja2VyOiBhbnkgPSB7fTsgLy8gVHJhY2sgRWRpdCBvcHRpb25zLlxuICBpbnRlcm5hbF9jb25maWdzOiBhbnkgPSB7XG4gICAgc2hvd19hZGRfcm93OiBmYWxzZSxcbiAgICBzaG93X3BhcmVudF9jb2w6IGZhbHNlLFxuICAgIGFsbF9zZWxlY3RlZDogZmFsc2VcbiAgfTtcbiAgc3RvcmUgPSBuZXcgU3RvcmUodGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlKTtcblxuICBASW5wdXQoKVxuICBkYXRhOiBhbnlbXTtcblxuICBASW5wdXQoKVxuICBjb25maWdzOiBDb25maWdzO1xuXG4gIGRlZmF1bHRfY29uZmlnczogQ29uZmlncyA9IHtcbiAgICBjc3M6IHtcbiAgICAgIGV4cGFuZF9pY29uOiAnJyxcbiAgICAgIGNvbGxhcHNlX2ljb246ICcnLFxuICAgICAgYWRkX2ljb246ICcnLFxuICAgICAgZWRpdF9pY29uOiAnJyxcbiAgICAgIGRlbGV0ZV9pY29uOiAnJyxcbiAgICAgIHNhdmVfaWNvbjogJycsXG4gICAgICBjYW5jZWxfaWNvbjogJycsXG4gICAgICByb3dfc2VsZWN0aW9uX2NsYXNzOiAnc2VsZWN0ZWQnLFxuICAgICAgaGVhZGVyX2NsYXNzOiAnJyxcbiAgICAgIHJvd19maWx0ZXJfY2xhc3M6ICcnLFxuICAgICAgdGFibGVfY2xhc3M6ICcnXG4gICAgfSxcbiAgICBhY3Rpb25zOiB7XG4gICAgICBlZGl0OiBmYWxzZSxcbiAgICAgIGFkZDogZmFsc2UsXG4gICAgICBkZWxldGU6IGZhbHNlLFxuICAgICAgcmVzb2x2ZV9lZGl0OiBmYWxzZSxcbiAgICAgIHJlc29sdmVfYWRkOiBmYWxzZSxcbiAgICAgIHJlc29sdmVfZGVsZXRlOiBmYWxzZSxcbiAgICAgIGVkaXRfcGFyZW50OiBmYWxzZVxuICAgIH0sXG4gICAgZGF0YV9sb2FkaW5nX3RleHQ6ICdMb2FkaW5nLi4uJyxcbiAgICBmaWx0ZXI6IGZhbHNlLFxuICAgIG11bHRpX3NlbGVjdDogZmFsc2UsXG4gICAgc2hvd19wYXJlbnRfb25fZWRpdDogdHJ1ZSxcbiAgICBzaG93X3N1bW1hcnlfcm93OiBmYWxzZSxcbiAgICBzdWJncmlkOiBmYWxzZSxcbiAgICBsb2FkX2NoaWxkcmVuX29uX2V4cGFuZDogZmFsc2UsXG4gICAgYWN0aW9uX2NvbHVtbl93aWR0aDogJzYwcHgnLFxuICAgIHJvd19jbGFzc19mdW5jdGlvbjogKCkgPT4gJycsXG4gICAgcm93X2VkaXRfZnVuY3Rpb246ICgpID0+IHRydWUsXG4gICAgcm93X2RlbGV0ZV9mdW5jdGlvbjogKCkgPT4gdHJ1ZSxcbiAgICBzdWJncmlkX2NvbmZpZzoge1xuICAgICAgc2hvd19zdW1tYXJ5X3JvdzogZmFsc2UsXG4gICAgICBkYXRhX2xvYWRpbmdfdGV4dDogJ0xvYWRpbmcuLi4nXG4gICAgfVxuICB9O1xuICBkZWZhdWx0X2NvbHVtbl9jb25maWc6IENvbHVtbiA9IHtcbiAgICBzb3J0ZWQ6IDAsXG4gICAgc29ydF90eXBlOiBudWxsLFxuICAgIGVkaXRhYmxlOiBmYWxzZSxcbiAgICBoaWRkZW46IGZhbHNlLFxuICAgIGZpbHRlcjogdHJ1ZSxcbiAgICBjYXNlX3NlbnNpdGl2ZV9maWx0ZXI6IGZhbHNlXG4gIH07XG5cbiAgIEBPdXRwdXQoKSBjZWxsY2xpY2s6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgQE91dHB1dCgpIGV4cGFuZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICBAT3V0cHV0KCkgY29sbGFwc2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgQE91dHB1dCgpIHJvd3NlbGVjdDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICBAT3V0cHV0KCkgcm93ZGVzZWxlY3Q6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgQE91dHB1dCgpIHJvd3NlbGVjdGFsbDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICBAT3V0cHV0KCkgcm93ZGVzZWxlY3RhbGw6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgQE91dHB1dCgpIHJvd2FkZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICBAT3V0cHV0KCkgcm93c2F2ZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICBAT3V0cHV0KCkgcm93ZGVsZXRlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFuZ3VsYXJUcmVlR3JpZFNlcnZpY2U6IEFuZ3VsYXJUcmVlR3JpZFNlcnZpY2UpIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy52YWxpZGF0ZUNvbmZpZ3MoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnNldERlZmF1bHRDb25maWdzKCk7XG4gICAgdGhpcy5zZXRDb2x1bW5OYW1lcygpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgaWYgKCF0aGlzLnZhbGlkYXRlQ29uZmlncygpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuc2V0RGVmYXVsdENvbmZpZ3MoKTtcbiAgICB0aGlzLnNldENvbHVtbk5hbWVzKCk7XG4gICAgdGhpcy5zdG9yZS5wcm9jZXNzRGF0YShcbiAgICAgIHRoaXMuZGF0YSxcbiAgICAgIHRoaXMuZXhwYW5kX3RyYWNrZXIsXG4gICAgICB0aGlzLmNvbmZpZ3MsXG4gICAgICB0aGlzLmVkaXRfdHJhY2tlcixcbiAgICAgIHRoaXMuaW50ZXJuYWxfY29uZmlnc1xuICAgICk7XG4gIH1cblxuICB2YWxpZGF0ZUNvbmZpZ3MoKSB7XG4gICAgaWYgKCF0aGlzLmRhdGEpIHtcbiAgICAgIHdpbmRvdy5jb25zb2xlLndhcm4oJ2RhdGEgY2FuXFwndCBiZSBlbXB0eSEnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmNvbmZpZ3MpIHtcbiAgICAgIHdpbmRvdy5jb25zb2xlLndhcm4oJ2NvbmZpZ3MgY2FuXFwndCBiZSBlbXB0eSEnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZGF0YVswXTtcbiAgICBsZXQgaXNWYWxpZGF0ZWQgPSB0cnVlO1xuXG4gICAgaWYgKCF0aGlzLmNvbmZpZ3MuaWRfZmllbGQpIHtcbiAgICAgIGlzVmFsaWRhdGVkID0gZmFsc2U7XG4gICAgICB3aW5kb3cuY29uc29sZS5lcnJvcignaWQgZmllbGQgaXMgbWFuZGF0b3J5IScpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5jb25maWdzLnBhcmVudF9pZF9maWVsZCAmJiAhdGhpcy5jb25maWdzLnN1YmdyaWQpIHtcbiAgICAgIGlzVmFsaWRhdGVkID0gZmFsc2U7XG4gICAgICB3aW5kb3cuY29uc29sZS5lcnJvcigncGFyZW50X2lkIGZpZWxkIGlzIG1hbmRhdG9yeSEnKTtcbiAgICB9XG5cbiAgICBpZiAoZWxlbWVudCAmJiAhZWxlbWVudC5oYXNPd25Qcm9wZXJ0eSh0aGlzLmNvbmZpZ3MuaWRfZmllbGQpKSB7XG4gICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgY29uc29sZS5lcnJvcignaWRfZmllbGQgZG9lc25cXCd0IGV4aXN0IScpO1xuICAgIH1cblxuICAgIGlmIChlbGVtZW50ICYmICFlbGVtZW50Lmhhc093blByb3BlcnR5KHRoaXMuY29uZmlncy5wYXJlbnRfaWRfZmllbGQpXG4gICAgICAgICYmICF0aGlzLmNvbmZpZ3Muc3ViZ3JpZFxuICAgICAgICAmJiAhdGhpcy5jb25maWdzLmxvYWRfY2hpbGRyZW5fb25fZXhwYW5kKSB7XG4gICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgY29uc29sZS5lcnJvcigncGFyZW50X2lkX2ZpZWxkIGRvZXNuXFwndCBleGlzdCEnKTtcbiAgICB9XG5cbiAgICBpZiAoZWxlbWVudCAmJiAhZWxlbWVudC5oYXNPd25Qcm9wZXJ0eSh0aGlzLmNvbmZpZ3MucGFyZW50X2Rpc3BsYXlfZmllbGQpKSB7XG4gICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgY29uc29sZS5lcnJvcigncGFyZW50X2Rpc3BsYXlfZmllbGQgZG9lc25cXCd0IGV4aXN0ISBCYXNpY2FsbHkgdGhpcyBmaWVsZCB3aWxsIGJlIGV4cGFuZGVkLicpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZ3Muc3ViZ3JpZCAmJiAhdGhpcy5jb25maWdzLnN1YmdyaWRfY29uZmlnKSB7XG4gICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgY29uc29sZS5lcnJvcignc3ViZ3JpZF9jb25maWcgZG9lc25cXCd0IGV4aXN0IScpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZ3Muc3ViZ3JpZCAmJiB0aGlzLmNvbmZpZ3Muc3ViZ3JpZF9jb25maWcgJiYgIXRoaXMuY29uZmlncy5zdWJncmlkX2NvbmZpZy5pZF9maWVsZCkge1xuICAgICAgaXNWYWxpZGF0ZWQgPSBmYWxzZTtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2lkX2ZpZWxkIG9mIHN1YmdyaWQgZG9lc25cXCd0IGV4aXN0IScpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbmZpZ3Muc3ViZ3JpZCAmJiB0aGlzLmNvbmZpZ3Muc3ViZ3JpZF9jb25maWcgJiYgIXRoaXMuY29uZmlncy5zdWJncmlkX2NvbmZpZy5jb2x1bW5zKSB7XG4gICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgY29uc29sZS5lcnJvcignY29sdW1ucyBvZiBzdWJncmlkIGRvZXNuXFwndCBleGlzdCEnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaXNWYWxpZGF0ZWQ7XG4gIH1cblxuICBzZXREZWZhdWx0Q29uZmlncygpIHtcbiAgICB0aGlzLnByb2Nlc3NlZF9kYXRhID0gW107XG4gICAgdGhpcy5jb25maWdzID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5kZWZhdWx0X2NvbmZpZ3MsIHRoaXMuY29uZmlncyk7XG5cbiAgICAvLyBEZWVwIGNsb25lLlxuICAgIHRoaXMuY29uZmlncy5hY3Rpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5kZWZhdWx0X2NvbmZpZ3MuYWN0aW9ucywgdGhpcy5jb25maWdzLmFjdGlvbnMpO1xuICAgIHRoaXMuY29uZmlncy5jc3MgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmRlZmF1bHRfY29uZmlncy5jc3MsIHRoaXMuY29uZmlncy5jc3MpO1xuICAgIHRoaXMuY29uZmlncy5zdWJncmlkX2NvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZGVmYXVsdF9jb25maWdzLnN1YmdyaWRfY29uZmlnLCB0aGlzLmNvbmZpZ3Muc3ViZ3JpZF9jb25maWcpO1xuXG4gICAgaWYgKHRoaXMuY29uZmlncy5zdWJncmlkKSB7XG4gICAgICB0aGlzLmNvbmZpZ3MuYWN0aW9ucy5hZGQgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBzZXRDb2x1bW5OYW1lcygpIHtcbiAgICB0aGlzLmNvbHVtbnMgPSB0aGlzLmNvbmZpZ3MuY29sdW1ucyA/IHRoaXMuY29uZmlncy5jb2x1bW5zIDogW107XG5cbiAgICAvLyBJZiBjb2x1bW5zIGRvZXNuJ3QgZXhpc3QgaW4gdXNlcidzIG9iamVjdC5cbiAgICBpZiAoIXRoaXMuY29uZmlncy5jb2x1bW5zKSB7XG4gICAgICBjb25zdCBjb2x1bW5fa2V5cyA9IE9iamVjdC5rZXlzKHRoaXMuZGF0YVswXSk7XG5cbiAgICAgIC8vIEluc2VydCBIZWFkZXIgYW5kIGRlZmF1bHQgY29uZmlndXJhdGlvbi5cbiAgICAgIGNvbHVtbl9rZXlzLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgdGhpcy5jb2x1bW5zLnB1c2goT2JqZWN0LmFzc2lnbih7J2hlYWRlcic6IGtleSwgJ25hbWUnOiBrZXl9LCB0aGlzLmRlZmF1bHRfY29sdW1uX2NvbmZpZykpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcblxuICAgICAgLy8gSW5zZXJ0IEhlYWRlciBhbmQgZGVmYXVsdCBjb25maWd1cmF0aW9uLlxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvbHVtbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5jb2x1bW5zW2ldID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5kZWZhdWx0X2NvbHVtbl9jb25maWcsIHRoaXMuY29sdW1uc1tpXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29sbGFwc2VBbGwoKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmNvbGxhcHNlQWxsKHRoaXMuZXhwYW5kX3RyYWNrZXIpO1xuICB9XG5cbiAgZXhwYW5kQWxsKCkge1xuICAgIHRoaXMuYW5ndWxhclRyZWVHcmlkU2VydmljZS5leHBhbmRBbGwodGhpcy5leHBhbmRfdHJhY2tlcik7XG4gIH1cblxuICBzZWxlY3RBbGwoKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLnNlbGVjdEFsbCh0aGlzLnN0b3JlLmdldERpc3BsYXlEYXRhKCkpO1xuICAgIHRoaXMuaW50ZXJuYWxfY29uZmlncy5hbGxfc2VsZWN0ZWQgPSB0cnVlO1xuICB9XG5cbiAgZGVTZWxlY3RBbGwoKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmRlU2VsZWN0QWxsKHRoaXMuc3RvcmUuZ2V0RGlzcGxheURhdGEoKSk7XG4gICAgdGhpcy5pbnRlcm5hbF9jb25maWdzLmFsbF9zZWxlY3RlZCA9IGZhbHNlO1xuICB9XG5cbiAgZXhwYW5kUm93KHJvd19pZCwgc3VwcHJlc3NfZXZlbnQ/OiBmYWxzZSkge1xuICAgIHRoaXMuYW5ndWxhclRyZWVHcmlkU2VydmljZS5leHBhbmRSb3cocm93X2lkLCB0aGlzLmV4cGFuZF90cmFja2VyLCB0aGlzLmV4cGFuZCwgc3VwcHJlc3NfZXZlbnQsXG4gICAgICAgICB0aGlzLmNvbmZpZ3MsIHRoaXMuc3RvcmUuZ2V0RGlzcGxheURhdGEoKSwgdGhpcy5zdG9yZSk7XG4gIH1cblxuICBjb2xsYXBzZVJvdyhyb3dfaWQsIHN1cHByZXNzX2V2ZW50PzogZmFsc2UpIHtcbiAgICB0aGlzLmFuZ3VsYXJUcmVlR3JpZFNlcnZpY2UuY29sbGFwc2VSb3cocm93X2lkLCB0aGlzLmV4cGFuZF90cmFja2VyLCB0aGlzLmNvbGxhcHNlLCBzdXBwcmVzc19ldmVudCxcbiAgICAgIHRoaXMuY29uZmlncywgdGhpcy5zdG9yZS5nZXREaXNwbGF5RGF0YSgpKTtcbiAgfVxuXG4gIGRpc2FibGVSb3dTZWxlY3Rpb24ocm93X2lkKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmRpc2FibGVSb3dTZWxlY3Rpb24odGhpcy5zdG9yZS5nZXREaXNwbGF5RGF0YSgpLCB0aGlzLmNvbmZpZ3MsIHJvd19pZCk7XG4gIH1cblxuICBlbmFibGVSb3dTZWxlY3Rpb24ocm93X2lkKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmVuYWJsZVJvd1NlbGVjdGlvbih0aGlzLnN0b3JlLmdldERpc3BsYXlEYXRhKCksIHRoaXMuY29uZmlncywgcm93X2lkKTtcbiAgfVxuXG4gIGRpc2FibGVSb3dFeHBhbmQocm93X2lkKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmRpc2FibGVSb3dFeHBhbmQodGhpcy5zdG9yZS5nZXREaXNwbGF5RGF0YSgpLCB0aGlzLmNvbmZpZ3MsIHJvd19pZCk7XG4gIH1cblxuICBlbmFibGVSb3dFeHBhbmQocm93X2lkKSB7XG4gICAgdGhpcy5hbmd1bGFyVHJlZUdyaWRTZXJ2aWNlLmVuYWJsZVJvd0V4cGFuZCh0aGlzLnN0b3JlLmdldERpc3BsYXlEYXRhKCksIHRoaXMuY29uZmlncywgcm93X2lkKTtcbiAgfVxuXG59XG4iLCI8dGFibGUgW2F0dHIuY2xhc3NdPVwiJ2RiLXRyZWUtdmlldyAnICsgY29uZmlncy5jc3MudGFibGVfY2xhc3NcIiA+XG4gICAgPHRoZWFkIFxuICAgICAgICBkYi10cmVlLWhlYWRcbiAgICAgICAgW3N0b3JlXT1cInN0b3JlXCJcbiAgICAgICAgW2V4cGFuZF90cmFja2VyXT1cImV4cGFuZF90cmFja2VyXCJcbiAgICAgICAgW2ludGVybmFsX2NvbmZpZ3NdPVwiaW50ZXJuYWxfY29uZmlnc1wiXG4gICAgICAgIFtlZGl0X3RyYWNrZXJdPVwiZWRpdF90cmFja2VyXCJcbiAgICAgICAgW3Jvd3NlbGVjdGFsbF09XCJyb3dzZWxlY3RhbGxcIlxuICAgICAgICBbcm93ZGVzZWxlY3RhbGxdPVwicm93ZGVzZWxlY3RhbGxcIlxuICAgICAgICBbY29sdW1uc109XCJjb2x1bW5zXCJcbiAgICAgICAgW2NvbmZpZ3NdPVwiY29uZmlnc1wiPlxuICAgIDwvdGhlYWQ+XG5cbiAgICA8dGJvZHkgXG4gICAgICAgIGRiLXRyZWUtYm9keVxuICAgICAgICBbc3RvcmVdPVwic3RvcmVcIlxuICAgICAgICBbZXhwYW5kX3RyYWNrZXJdPVwiZXhwYW5kX3RyYWNrZXJcIlxuICAgICAgICBbZWRpdF90cmFja2VyXT1cImVkaXRfdHJhY2tlclwiXG4gICAgICAgIFtpbnRlcm5hbF9jb25maWdzXT1cImludGVybmFsX2NvbmZpZ3NcIlxuICAgICAgICBbY29sdW1uc109XCJjb2x1bW5zXCJcbiAgICAgICAgW2NvbmZpZ3NdPVwiY29uZmlnc1wiXG4gICAgICAgIFtjZWxsY2xpY2tdPVwiY2VsbGNsaWNrXCJcbiAgICAgICAgW2V4cGFuZF09XCJleHBhbmRcIlxuICAgICAgICBbY29sbGFwc2VdPVwiY29sbGFwc2VcIlxuICAgICAgICBbcm93ZGVsZXRlXT1cInJvd2RlbGV0ZVwiXG4gICAgICAgIFtyb3dzYXZlXT1cInJvd3NhdmVcIlxuICAgICAgICBbcm93YWRkXT1cInJvd2FkZFwiXG4gICAgICAgIFtyb3dzZWxlY3RdPVwicm93c2VsZWN0XCJcbiAgICAgICAgW3Jvd2Rlc2VsZWN0XT1cInJvd2Rlc2VsZWN0XCJcbiAgICA+ICAgICAgICBcbiAgICA8L3Rib2R5PlxuPC90YWJsZT4iXX0=